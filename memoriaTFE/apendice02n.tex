\documentclass[12pt,a4paper,]{book}
\def\ifdoblecara{} %% set to true
\def\ifprincipal{} %% set to true
\let\ifprincipal\undefined %% set to false
\def\ifcitapandoc{} %% set to true
\let\ifcitapandoc\undefined %% set to false
\usepackage{lmodern}
% sin fontmathfamily
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
%\usepackage{fixltx2e} % provides \textsubscript %PLLC
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin = 2.5cm]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdfauthor={Nombre Completo Autor},
              pdfborder={0 0 0},
              breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
%
\usepackage[usenames,dvipsnames]{xcolor}  %new PLLC
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}

% PLLC modifica-ini
% PLLC modifica-fin

\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}


  \title{}
    \author{Nombre Completo Autor}
      \date{18/11/2021}


%%%%%%% inicio: latex_preambulo.tex PLLC


%% UTILIZA CODIFICACIÓN UTF-8
%% MODIFICARLO CONVENIENTEMENTE PARA USARLO CON OTRAS CODIFICACIONES


%\usepackage[spanish,es-nodecimaldot,es-noshorthands]{babel}
\usepackage[spanish,es-nodecimaldot,es-noshorthands,es-tabla]{babel}
% Ver: es-tabla (en: https://osl.ugr.es/CTAN/macros/latex/contrib/babel-contrib/spanish/spanish.pdf)
% es-tabla (en: https://tex.stackexchange.com/questions/80443/change-the-word-table-in-table-captions)
\usepackage[spanish, plain, datebegin,sortcompress,nocomment,
noabstract]{flexbib}
 
\usepackage{float}
\usepackage{placeins}
\usepackage{fancyhdr}
% Solucion: ! LaTeX Error: Command \counterwithout already defined.
% https://tex.stackexchange.com/questions/425600/latex-error-command-counterwithout-already-defined
\let\counterwithout\relax
\let\counterwithin\relax
\usepackage{chngcntr}
%\usepackage{microtype}  %antes en template PLLC
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc} % Usa codificación 8-bit que tiene 256 glyphs

%\usepackage[dvipsnames]{xcolor}
%\usepackage[usenames,dvipsnames]{xcolor}  %new
\usepackage{pdfpages}
%\usepackage{natbib}




% Para portada: latex_paginatitulo_mod_ST02.tex (inicio)
\usepackage{tikz}
\usepackage{epigraph}
\input{portadas/latex_paginatitulo_mod_ST02_add.sty}
% Para portada: latex_paginatitulo_mod_ST02.tex (fin)

% Para portada: latex_paginatitulo_mod_OV01.tex (inicio)
\usepackage{cpimod}
% Para portada: latex_paginatitulo_mod_OV01.tex (fin)

% Para portada: latex_paginatitulo_mod_OV03.tex (inicio)
\usepackage{KTHEEtitlepage}
% Para portada: latex_paginatitulo_mod_OV03.tex (fin)

\renewcommand{\contentsname}{Índice}
\renewcommand{\listfigurename}{Índice de figuras}
\renewcommand{\listtablename}{Índice de tablas}
\newcommand{\bcols}{}
\newcommand{\ecols}{}
\newcommand{\bcol}[1]{\begin{minipage}{#1\linewidth}}
\newcommand{\ecol}{\end{minipage}}
\newcommand{\balertblock}[1]{\begin{alertblock}{#1}}
\newcommand{\ealertblock}{\end{alertblock}}
\newcommand{\bitemize}{\begin{itemize}}
\newcommand{\eitemize}{\end{itemize}}
\newcommand{\benumerate}{\begin{enumerate}}
\newcommand{\eenumerate}{\end{enumerate}}
\newcommand{\saltopagina}{\newpage}
\newcommand{\bcenter}{\begin{center}}
\newcommand{\ecenter}{\end{center}}
\newcommand{\beproof}{\begin{proof}} %new
\newcommand{\eeproof}{\end{proof}} %new
%De: https://texblog.org/2007/11/07/headerfooter-in-latex-with-fancyhdr/
% \fancyhead
% E: Even page
% O: Odd page
% L: Left field
% C: Center field
% R: Right field
% H: Header
% F: Footer
%\fancyhead[CO,CE]{Resultados}

%OPCION 1
% \fancyhead[LE,RO]{\slshape \rightmark}
% \fancyhead[LO,RE]{\slshape \leftmark}
% \fancyfoot[C]{\thepage}
% \renewcommand{\headrulewidth}{0.4pt}
% \renewcommand{\footrulewidth}{0pt}

%OPCION 2
% \fancyhead[LE,RO]{\slshape \rightmark}
% \fancyfoot[LO,RE]{\slshape \leftmark}
% \fancyfoot[LE,RO]{\thepage}
% \renewcommand{\headrulewidth}{0.4pt}
% \renewcommand{\footrulewidth}{0.4pt}
%%%%%%%%%%
\usepackage{calc,amsfonts}
% Elimina la cabecera de páginas impares vacías al finalizar los capítulos
\usepackage{emptypage}
\makeatletter

%\definecolor{ocre}{RGB}{25,25,243} % Define el color azul (naranja) usado para resaltar algunas salidas
\definecolor{ocre}{RGB}{0,0,0} % Define el color a negro (aparece en los teoremas

%\usepackage{calc} 


%era if(csl-refs) con dolares
% metodobib: true


\usepackage{lipsum}

%\usepackage{tikz} % Requerido para dibujar formas personalizadas

%\usepackage{amsmath,amsthm,amssymb,amsfonts}
\usepackage{amsthm}


% Boxed/framed environments
\newtheoremstyle{ocrenumbox}% % Theorem style name
{0pt}% Space above
{0pt}% Space below
{\normalfont}% % Body font
{}% Indent amount
{\small\bf\sffamily\color{ocre}}% % Theorem head font
{\;}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\color{ocre}\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries\color{black}---\nobreakspace#3.}} % Optional theorem note
\renewcommand{\qedsymbol}{$\blacksquare$}% Optional qed square

\newtheoremstyle{blacknumex}% Theorem style name
{5pt}% Space above
{5pt}% Space below
{\normalfont}% Body font
{} % Indent amount
{\small\bf\sffamily}% Theorem head font
{\;}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily{\tiny\ensuremath{\blacksquare}}\nobreakspace\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries---\nobreakspace#3.}}% Optional theorem note

\newtheoremstyle{blacknumbox} % Theorem style name
{0pt}% Space above
{0pt}% Space below
{\normalfont}% Body font
{}% Indent amount
{\small\bf\sffamily}% Theorem head font
{\;}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries---\nobreakspace#3.}}% Optional theorem note

% Non-boxed/non-framed environments
\newtheoremstyle{ocrenum}% % Theorem style name
{5pt}% Space above
{5pt}% Space below
{\normalfont}% % Body font
{}% Indent amount
{\small\bf\sffamily\color{ocre}}% % Theorem head font
{\;}% Punctuation after theorem head
{0.25em}% Space after theorem head
{\small\sffamily\color{ocre}\thmname{#1}\nobreakspace\thmnumber{\@ifnotempty{#1}{}\@upn{#2}}% Theorem text (e.g. Theorem 2.1)
\thmnote{\nobreakspace\the\thm@notefont\sffamily\bfseries\color{black}---\nobreakspace#3.}} % Optional theorem note
\renewcommand{\qedsymbol}{$\blacksquare$}% Optional qed square
\makeatother



% Define el estilo texto theorem para cada tipo definido anteriormente
\newcounter{dummy} 
\numberwithin{dummy}{section}
\theoremstyle{ocrenumbox}
\newtheorem{theoremeT}[dummy]{Teorema}  % (Pedro: Theorem)
\newtheorem{problem}{Problema}[chapter]  % (Pedro: Problem)
\newtheorem{exerciseT}{Ejercicio}[chapter] % (Pedro: Exercise)
\theoremstyle{blacknumex}
\newtheorem{exampleT}{Ejemplo}[chapter] % (Pedro: Example)
\theoremstyle{blacknumbox}
\newtheorem{vocabulary}{Vocabulario}[chapter]  % (Pedro: Vocabulary)
\newtheorem{definitionT}{Definición}[section]  % (Pedro: Definition)
\newtheorem{corollaryT}[dummy]{Corolario}  % (Pedro: Corollary)
\theoremstyle{ocrenum}
\newtheorem{proposition}[dummy]{Proposición} % (Pedro: Proposition)


\usepackage[framemethod=default]{mdframed}



\newcommand{\intoo}[2]{\mathopen{]}#1\,;#2\mathclose{[}}
\newcommand{\ud}{\mathop{\mathrm{{}d}}\mathopen{}}
\newcommand{\intff}[2]{\mathopen{[}#1\,;#2\mathclose{]}}
\newtheorem{notation}{Notation}[chapter]


\mdfdefinestyle{exampledefault}{%
rightline=true,innerleftmargin=10,innerrightmargin=10,
frametitlerule=true,frametitlerulecolor=green,
frametitlebackgroundcolor=yellow,
frametitlerulewidth=2pt}


% Theorem box
\newmdenv[skipabove=7pt,
skipbelow=7pt,
backgroundcolor=black!5,
linecolor=ocre,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=10pt,%5pt
leftmargin=0cm,
rightmargin=0cm,
innerbottommargin=5pt]{tBox}

% Exercise box	  
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
backgroundcolor=ocre!10,
linecolor=ocre,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=10pt,%5pt
innerbottommargin=5pt,
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt]{eBox}	

% Definition box
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
linecolor=ocre,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=10pt,%0pt
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt,
innerbottommargin=0pt]{dBox}	

% Corollary box
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
linecolor=gray,
backgroundcolor=black!5,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=10pt,%5pt
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt,
innerbottommargin=5pt]{cBox}

% Crea un entorno para cada tipo de theorem y le asigna un estilo 
% con ayuda de las cajas coloreadas anteriores
\newenvironment{theorem}{\begin{tBox}\begin{theoremeT}}{\end{theoremeT}\end{tBox}}
\newenvironment{exercise}{\begin{eBox}\begin{exerciseT}}{\hfill{\color{ocre}\tiny\ensuremath{\blacksquare}}\end{exerciseT}\end{eBox}}				  
\newenvironment{definition}{\begin{dBox}\begin{definitionT}}{\end{definitionT}\end{dBox}}	
\newenvironment{example}{\begin{exampleT}}{\hfill{\tiny\ensuremath{\blacksquare}}\end{exampleT}}		
\newenvironment{corollary}{\begin{cBox}\begin{corollaryT}}{\end{corollaryT}\end{cBox}}	

%	ENVIRONMENT remark
\newenvironment{remark}{\par\vspace{10pt}\small 
% Espacio blanco vertical sobre la nota y tamaño de fuente menor
\begin{list}{}{
\leftmargin=35pt % Indentación sobre la izquierda
\rightmargin=25pt}\item\ignorespaces % Indentación sobre la derecha
\makebox[-2.5pt]{\begin{tikzpicture}[overlay]
\node[draw=ocre!60,line width=1pt,circle,fill=ocre!25,font=\sffamily\bfseries,inner sep=2pt,outer sep=0pt] at (-15pt,0pt){\textcolor{ocre}{N}}; \end{tikzpicture}} % R naranja en un círculo (Pedro)
\advance\baselineskip -1pt}{\end{list}\vskip5pt} 
% Espaciado de línea más estrecho y espacio en blanco después del comentario


\newenvironment{solutionExe}{\par\vspace{10pt}\small 
\begin{list}{}{
\leftmargin=35pt 
\rightmargin=25pt}\item\ignorespaces 
\makebox[-2.5pt]{\begin{tikzpicture}[overlay]
\node[draw=ocre!60,line width=1pt,circle,fill=ocre!25,font=\sffamily\bfseries,inner sep=2pt,outer sep=0pt] at (-15pt,0pt){\textcolor{ocre}{S}}; \end{tikzpicture}} 
\advance\baselineskip -1pt}{\end{list}\vskip5pt} 

\newenvironment{solutionExa}{\par\vspace{10pt}\small 
\begin{list}{}{
\leftmargin=35pt 
\rightmargin=25pt}\item\ignorespaces 
\makebox[-2.5pt]{\begin{tikzpicture}[overlay]
\node[draw=ocre!60,line width=1pt,circle,fill=ocre!55,font=\sffamily\bfseries,inner sep=2pt,outer sep=0pt] at (-15pt,0pt){\textcolor{ocre}{S}}; \end{tikzpicture}} 
\advance\baselineskip -1pt}{\end{list}\vskip5pt} 

\usepackage{tcolorbox}

\usetikzlibrary{trees}

\theoremstyle{ocrenum}
\newtheorem{solutionT}[dummy]{Solución}  % (Pedro: Corollary)
\newenvironment{solution}{\begin{cBox}\begin{solutionT}}{\end{solutionT}\end{cBox}}	


\newcommand{\tcolorboxsolucion}[2]{%
\begin{tcolorbox}[colback=green!5!white,colframe=green!75!black,title=#1] 
 #2
 %\tcblower  % pone una línea discontinua
\end{tcolorbox}
}% final definición comando

\newtcbox{\mybox}[1][green]{on line,
arc=0pt,outer arc=0pt,colback=#1!10!white,colframe=#1!50!black, boxsep=0pt,left=1pt,right=1pt,top=2pt,bottom=2pt, boxrule=0pt,bottomrule=1pt,toprule=1pt}



\mdfdefinestyle{exampledefault}{%
rightline=true,innerleftmargin=10,innerrightmargin=10,
frametitlerule=true,frametitlerulecolor=green,
frametitlebackgroundcolor=yellow,
frametitlerulewidth=2pt}





\newcommand{\betheorem}{\begin{theorem}}
\newcommand{\eetheorem}{\end{theorem}}
\newcommand{\bedefinition}{\begin{definition}}
\newcommand{\eedefinition}{\end{definition}}

\newcommand{\beremark}{\begin{remark}}
\newcommand{\eeremark}{\end{remark}}
\newcommand{\beexercise}{\begin{exercise}}
\newcommand{\eeexercise}{\end{exercise}}
\newcommand{\beexample}{\begin{example}}
\newcommand{\eeexample}{\end{example}}
\newcommand{\becorollary}{\begin{corollary}}
\newcommand{\eecorollary}{\end{corollary}}


\newcommand{\besolutionExe}{\begin{solutionExe}}
\newcommand{\eesolutionExe}{\end{solutionExe}}
\newcommand{\besolutionExa}{\begin{solutionExa}}
\newcommand{\eesolutionExa}{\end{solutionExa}}


%%%%%%%%


% Caja Salida Markdown
\newmdenv[skipabove=7pt,
skipbelow=7pt,
rightline=false,
leftline=true,
topline=false,
bottomline=false,
backgroundcolor=GreenYellow!10,
linecolor=GreenYellow!80,
innerleftmargin=5pt,
innerrightmargin=5pt,
innertopmargin=10pt,%5pt
innerbottommargin=5pt,
leftmargin=0cm,
rightmargin=0cm,
linewidth=4pt]{mBox}	

%% RMarkdown
\newenvironment{markdownsal}{\begin{mBox}}{\end{mBox}}	

\newcommand{\bmarkdownsal}{\begin{markdownsal}}
\newcommand{\emarkdownsal}{\end{markdownsal}}


\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{subfig} %new
%\usepackage{booktabs,dcolumn,rotating,thumbpdf,longtable}
\usepackage{dcolumn,rotating}  %new
\usepackage[graphicx]{realboxes} %new de: https://stackoverflow.com/questions/51633434/prevent-pagebreak-in-kableextra-landscape-table

%define el interlineado vertical
%\renewcommand{\baselinestretch}{1.5}

%define etiqueta para las Tablas o Cuadros
%\renewcommand\spanishtablename{Tabla}

%%\bibliographystyle{plain} %new no necesario


%%%%%%%%%%%% PARA USO CON biblatex
% \DefineBibliographyStrings{english}{%
%   backrefpage = {ver pag.\adddot},%
%   backrefpages = {ver pags.\adddot}%
% }

% \DefineBibliographyStrings{spanish}{%
%   backrefpage = {ver pag.\adddot},%
%   backrefpages = {ver pags.\adddot}%
% }
% 
% \DeclareFieldFormat{pagerefformat}{\mkbibparens{{\color{red}\mkbibemph{#1}}}}
% \renewbibmacro*{pageref}{%
%   \iflistundef{pageref}
%     {}
%     {\printtext[pagerefformat]{%
%        \ifnumgreater{\value{pageref}}{1}
%          {\bibstring{backrefpages}\ppspace}
%          {\bibstring{backrefpage}\ppspace}%
%        \printlist[pageref][-\value{listtotal}]{pageref}}}}
% 
%%% de kableExtra
\usepackage{booktabs}
\usepackage{longtable}
%\usepackage{array}
%\usepackage{multirow}
%\usepackage{wrapfig}
%\usepackage{float}
%\usepackage{colortbl}
%\usepackage{pdflscape}
%\usepackage{tabu}
%\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}
%\usepackage{xcolor}

%%%%%%% fin: latex_preambulo.tex PLLC


\begin{document}

\bibliographystyle{flexbib}



\raggedbottom

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents

\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi

\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\hypertarget{apuxe9ndice-cuxf3digo}{%
\chapter{Apéndice: Código}\label{apuxe9ndice-cuxf3digo}}

\hypertarget{generaciuxf3n-de-la-muestra}{%
\section{Generación de la muestra}\label{generaciuxf3n-de-la-muestra}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Librerías {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan las librerías que se usarán en esta sección}

\FunctionTok{library}\NormalTok{(terra) }\CommentTok{\# Raster data}
\FunctionTok{library}\NormalTok{(sf) }\CommentTok{\# Vector data}
\FunctionTok{library}\NormalTok{(mapSpain) }\CommentTok{\# Polígonos de las regiones de España}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# Manipulación de datos}



\CommentTok{\# CRS de referencia {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Será el CRS que se use en todo el proyecto}

\NormalTok{pend }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_raw/topograficas/pendiente.tif"}\NormalTok{)}
\NormalTok{crs\_reference }\OtherTok{=} \FunctionTok{crs}\NormalTok{(pend)}
\FunctionTok{rm}\NormalTok{(pend) }\CommentTok{\# Se elimina de la memoria para liberar espacio}


\CommentTok{\# Polígono de Andalucía {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{Andalucia }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_ccaa}\NormalTok{(}\AttributeTok{ccaa =} \StringTok{"Andalucía"}\NormalTok{) }\CommentTok{\# Se obtiene el polígono de la comunidad autónoma de Andalucía}
\NormalTok{andalucia\_proj }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(Andalucia,crs\_reference) }\CommentTok{\# Se transforma al sistema de referencia usado en el proyecto}

\CommentTok{\# area\_monte es el área donde se generarán las muestras negativas.}

\CommentTok{\# Dado que no hay un mapa que indique claramente cuales son las zonas que se consideran "monte" en Andalucía y dado que los polígonos de incendios también cubren zonas agrícolas y urbanas (aunque menores en número que las zonas forestales), se considerará "monte" toda Andalucía, sin distinción. El sentido de esta variable es, precisamente, que pueda modificarse en futuros estudios}
\NormalTok{area\_monte }\OtherTok{\textless{}{-}}\NormalTok{ andalucia\_proj}

\CommentTok{\# Generación de la muestra {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# Generación de la muestra estratificando por mes de forma que la proporción de observaciones positivas y negativas por mes (en todo el periodo) sea la misma}

\DocumentationTok{\#\#  Tamaño muestral {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se dispone de 1089 incencios correctamente registrados entre 2002 y 2022}

\NormalTok{n\_in}\OtherTok{=}\DecValTok{10} \CommentTok{\# Número de puntos a muestrear dentro de cada poligono}
\NormalTok{n\_out}\OtherTok{=}\DecValTok{1089}\SpecialCharTok{*}\DecValTok{10} \CommentTok{\# Número de muestras negativas}

\DocumentationTok{\#\#  Generación aleatoria de fechas para las muestras negativas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# Primero se leen todos los datos de todos los archivos de incendios y se almacenan en la variable incendios}
\NormalTok{incendios }\OtherTok{=} \ConstantTok{NULL}

\ControlFlowTok{for}\NormalTok{ (year }\ControlFlowTok{in} \DecValTok{2002}\SpecialCharTok{:}\DecValTok{2022}\NormalTok{) \{}
\NormalTok{  incendios }\OtherTok{=} \FunctionTok{rbind}\NormalTok{(incendios, }
                    \FunctionTok{st\_read}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./data\_raw/incendios\_2000{-}2022/incendios\_"}\NormalTok{,year,}\StringTok{".shp"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
                      \FunctionTok{select}\NormalTok{(}\StringTok{"FECHA\_INIC"} \OtherTok{=} \FunctionTok{matches}\NormalTok{(}\StringTok{"(?i)\^{}FECHA\_INIC$|\^{}fecha\_inic.$"}\NormalTok{))) }
\NormalTok{\}}

\CommentTok{\# Se cuenta el número de incendios con fecha de inicio correcta en cada mes}
\NormalTok{incendios\_mes }\OtherTok{=}\NormalTok{ incendios }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{FECHA\_INIC =} \FunctionTok{ymd}\NormalTok{(FECHA\_INIC),}\AttributeTok{.keep=}\StringTok{"unused"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(FECHA\_INIC)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{year}\NormalTok{(FECHA\_INIC)}\SpecialCharTok{\textless{}=}\DecValTok{2022}\NormalTok{,}\FunctionTok{year}\NormalTok{(FECHA\_INIC)}\SpecialCharTok{\textgreater{}=}\DecValTok{2002}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{MES =} \FunctionTok{month}\NormalTok{(}\FunctionTok{month}\NormalTok{(FECHA\_INIC))) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{count}\NormalTok{(MES) }

\CommentTok{\# Fechas posibles para las muestras negativas}
\NormalTok{possible\_dates }\OtherTok{=} \FunctionTok{tibble}\NormalTok{ (}\AttributeTok{date =} \FunctionTok{seq}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\StringTok{\textquotesingle{}2002/01/01\textquotesingle{}}\NormalTok{), }\FunctionTok{as.Date}\NormalTok{(}\StringTok{\textquotesingle{}2022/12/31\textquotesingle{}}\NormalTok{), }\AttributeTok{by=}\StringTok{"day"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{MES =} \FunctionTok{month}\NormalTok{(date)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{left\_join}\NormalTok{(incendios\_mes,}
            \FunctionTok{join\_by}\NormalTok{(MES)) }

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12345}\NormalTok{) }\CommentTok{\# Se fija la semilla para que sea reproducible}

\CommentTok{\# Se generan fechas aleatorias para las muestras negativas entre 2002 y 2022 siguiendo con una distribución de probabilidad proporcional a la cantidad de incendios observados en cada mes}
\NormalTok{dates }\OtherTok{=} \FunctionTok{sample}\NormalTok{(possible\_dates}\SpecialCharTok{$}\NormalTok{date, }
\NormalTok{               n\_out,}\AttributeTok{replace =}\NormalTok{ T,}
               \AttributeTok{prob =}\NormalTok{ possible\_dates}\SpecialCharTok{$}\NormalTok{n) }

\FunctionTok{rm}\NormalTok{(incendios, possible\_dates) }\CommentTok{\# Se borran para liberar memoria}

\DocumentationTok{\#\#  Selección de localizaciones aleatorias {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Para la selección de la muestra se seguirá el siguiente procedimiento:}
\CommentTok{\# 1. Para las muestra positivas: Se tomarán n\_in puntos aleatorios dentro de cada polígono de incendio y se le asociará a cada uno de ellos la fecha de inicio del incendio.}
\CommentTok{\# 2. Para la muestras negativas: Se le asociará una localización aleatoria dentro de area\_monte a cada una de las fechas aleatorias generadas dentro del periodo de estudio (dates). Se tendrá en cuenta que no pueden haber muestras negativas a menos de 15km de una zona en la que haya habido un incendio en una franja de 6 días alrededor de la fecha de la observación (3 días antes a 3 días después).}

\NormalTok{points\_in }\OtherTok{=} \ConstantTok{NULL}  \CommentTok{\# Almacena las muestras positvas}
\NormalTok{points\_out }\OtherTok{=} \ConstantTok{NULL} \CommentTok{\# Almacena las muestras negativas}

\ControlFlowTok{for}\NormalTok{ (year }\ControlFlowTok{in} \DecValTok{2002}\SpecialCharTok{:}\DecValTok{2022}\NormalTok{) \{}
  
  \FunctionTok{cat}\NormalTok{(}\StringTok{"YEAR "}\NormalTok{, year,}\StringTok{" : {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"  Generando muestras positivas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  incendios }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./data\_raw/incendios\_2000{-}2022/incendios\_"}\NormalTok{,year,}\StringTok{".shp"}\NormalTok{),}\AttributeTok{quiet=}\NormalTok{T) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_transform}\NormalTok{(}\AttributeTok{crs =}\NormalTok{ crs\_reference) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{rename\_with}\NormalTok{(}\AttributeTok{.fn=}\NormalTok{tolower) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{fecha\_inic=}\FunctionTok{ymd}\NormalTok{(fecha\_inic),geometry,}\AttributeTok{.keep=}\StringTok{"none"}\NormalTok{)}
  
  
  \DocumentationTok{\#\# Generación de puntos positivos}
  
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(incendios)) \{}
\NormalTok{    point\_in\_sfc }\OtherTok{\textless{}{-}} \FunctionTok{st\_sample}\NormalTok{(incendios[i,],}\AttributeTok{size=}\NormalTok{n\_in) }\CommentTok{\# Se generan n\_i puntos dentro de cada incendio}
\NormalTok{    point\_in\_attr }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{fire =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,n\_in),}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendios[i,]}\SpecialCharTok{$}\NormalTok{fecha\_inic,n\_in))}
\NormalTok{    point\_in }\OtherTok{\textless{}{-}} \FunctionTok{st\_sf}\NormalTok{(point\_in\_attr,}\AttributeTok{geometry=}\NormalTok{ point\_in\_sfc)}
    
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(points\_in)) \{}
\NormalTok{      points\_in }\OtherTok{\textless{}{-}}\NormalTok{ point\_in }
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      points\_in }\OtherTok{\textless{}{-}}\NormalTok{ points\_in }\SpecialCharTok{|\textgreater{}} 
        \FunctionTok{add\_row}\NormalTok{(point\_in) }
\NormalTok{    \}}
\NormalTok{  \}}
  
  \DocumentationTok{\#\# Generación de puntos negativos}
  
  \FunctionTok{cat}\NormalTok{(}\StringTok{"  Generando muestras negativas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}\textgreater{} Nota: los puntos se generan en area\_monte}
  
\NormalTok{  dates\_year }\OtherTok{\textless{}{-}}\NormalTok{ dates[}\FunctionTok{year}\NormalTok{(dates) }\SpecialCharTok{==}\NormalTok{ year]}
\NormalTok{  locations }\OtherTok{=} \ConstantTok{NULL}
  
  \ControlFlowTok{for}\NormalTok{ (day }\ControlFlowTok{in}\NormalTok{ dates\_year) \{}
\NormalTok{    incendios\_day }\OtherTok{=} \FunctionTok{filter}\NormalTok{(incendios,fecha\_inic}\SpecialCharTok{\textgreater{}=}\NormalTok{day}\DecValTok{{-}3} \SpecialCharTok{\&}\NormalTok{ fecha\_inic}\SpecialCharTok{\textless{}=}\NormalTok{day}\SpecialCharTok{+}\DecValTok{3}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(incendios\_day)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{ }\CommentTok{\# Si no ha habido incendios en una franja de 6 días en Andalucía}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(locations)) \{}
\NormalTok{        locations }\OtherTok{=} \FunctionTok{st\_sample}\NormalTok{(area\_monte,}\AttributeTok{size=}\DecValTok{1}\NormalTok{)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        locations }\OtherTok{=} \FunctionTok{c}\NormalTok{(locations, }\FunctionTok{st\_sample}\NormalTok{(area\_monte,}\AttributeTok{size=}\DecValTok{1}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{ }\CommentTok{\# Si ha habido algún incendio en una franja de 6 días en Andalucía (3 antes o 3 después)}
      \ControlFlowTok{repeat}\NormalTok{ \{}
\NormalTok{        possible\_location }\OtherTok{=} \FunctionTok{st\_sample}\NormalTok{(area\_monte,}\AttributeTok{size=}\DecValTok{1}\NormalTok{)}
        \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{st\_is\_within\_distance}\NormalTok{(possible\_location,}\FunctionTok{st\_union}\NormalTok{(incendios\_day), }\AttributeTok{dist =} \DecValTok{15000}\NormalTok{, }\AttributeTok{sparse =} \ConstantTok{FALSE}\NormalTok{)) \{}
\NormalTok{          possible\_location }\OtherTok{=} \FunctionTok{st\_sample}\NormalTok{(area\_monte,}\AttributeTok{size=}\DecValTok{1}\NormalTok{)}
          \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(locations)) \{}
\NormalTok{            locations }\OtherTok{=}\NormalTok{ possible\_location}
            \ControlFlowTok{break}
\NormalTok{          \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{            locations }\OtherTok{=} \FunctionTok{c}\NormalTok{(locations, possible\_location)}
            \ControlFlowTok{break}
\NormalTok{          \}}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
  
  
\NormalTok{  points\_out\_attr }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{fire =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FunctionTok{length}\NormalTok{(dates\_year)),}\AttributeTok{date =}\NormalTok{ dates\_year)}
  
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(points\_out)) \{}
\NormalTok{    points\_out }\OtherTok{\textless{}{-}} \FunctionTok{st\_sf}\NormalTok{(points\_out\_attr,}\AttributeTok{geometry=}\NormalTok{ locations)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    points\_out }\OtherTok{\textless{}{-}}\NormalTok{ points\_out }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{add\_row}\NormalTok{(}\FunctionTok{st\_sf}\NormalTok{(points\_out\_attr,}\AttributeTok{geometry=}\NormalTok{ locations)) }
\NormalTok{  \}}
  
\NormalTok{\}}


\NormalTok{sample }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(points\_in,points\_out) }\CommentTok{\# La muestra generada}


\CommentTok{\# Comprobación y corrección {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\FunctionTok{summary}\NormalTok{(sample) }\CommentTok{\# Hay una fecha de un incendio errónea}
\FunctionTok{max}\NormalTok{(sample}\SpecialCharTok{$}\NormalTok{date,}\AttributeTok{na.rm=}\NormalTok{T) }\CommentTok{\# "2033{-}08{-}15"}

\CommentTok{\# Se eliminan las observaciones con fecha de incendio errónea que se han detectado}
\NormalTok{sample }\OtherTok{\textless{}{-}}\NormalTok{ sample[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(sample}\SpecialCharTok{$}\NormalTok{date}\SpecialCharTok{==}\FunctionTok{max}\NormalTok{(sample}\SpecialCharTok{$}\NormalTok{date,}\AttributeTok{na.rm=}\NormalTok{T)),]}
\FunctionTok{summary}\NormalTok{(sample) }\CommentTok{\# Corregido}

\CommentTok{\# Almacenamiento de resultados {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\FunctionTok{save}\NormalTok{(sample,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"salidas\_intermedias/sample\_strat\_"}\NormalTok{,}\FunctionTok{Sys.Date}\NormalTok{(),}\StringTok{".RData"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{asignaciuxf3n-de-variables-a-localizaciones}{%
\section{Asignación de variables a
localizaciones}\label{asignaciuxf3n-de-variables-a-localizaciones}}

A continuación se define la función \texttt{asignar\_variables} que dada
una muestra de puntos en Andalucía con fechas comprendidas entre 2002 y
2022 le asocia a cada observación todos los valores de las variables
consideradas en el estudio. Esta función se usará varias veces a lo
largo del trabajo.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Librerías {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan las librerías que se usarán en esta sección}
\FunctionTok{library}\NormalTok{(nasapower) }\CommentTok{\# Para obtener la información meteorológica}
\FunctionTok{library}\NormalTok{(raster, }\AttributeTok{include.only =} \FunctionTok{c}\NormalTok{(}\StringTok{"rasterFromXYZ"}\NormalTok{))  }\CommentTok{\# Función para construir rasters a partir de data.frames}
\FunctionTok{library}\NormalTok{(tidyverse) }
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(terra)}
\FunctionTok{library}\NormalTok{(mapSpain)}

\NormalTok{asignar\_variables }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(sample) \{}
  \CommentTok{\# Argumentos:}
  \CommentTok{\# * sample: objeto sf con una columna de geometrías de tipo POINT (dentro de los límites de Andalucía) y fechas comprendidas entre 01/01/2002 y 31/12/2022 }

  
\NormalTok{  crs\_reference }\OtherTok{=} \FunctionTok{st\_crs}\NormalTok{(sample) }\CommentTok{\# Se usa el sistema de referencia de coordenadas de la muestra}
\NormalTok{  and }\OtherTok{=} \FunctionTok{esp\_get\_ccaa}\NormalTok{(}\AttributeTok{ccaa =} \StringTok{"Andalucía"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos)) }\CommentTok{\# Polígono de Andalucía}
  
  \CommentTok{\# Variables meteorológicas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Asignando variables meteorológicas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \CommentTok{\# Tranformamos los datos a WGS84}
\NormalTok{  andalucia\_WGS84 }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(and,}\AttributeTok{crs=}\StringTok{"WGS84"}\NormalTok{)}
  
\NormalTok{  dataset }\OtherTok{=} \ConstantTok{NULL} \CommentTok{\# Variable en la que se almacenará el conjunto completo}
  
  \CommentTok{\# Se trabaja anualmente pues la API de NASA POWER solo admite consultas de hasta 366 días}

  \ControlFlowTok{for}\NormalTok{ (year }\ControlFlowTok{in} \FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(}\FunctionTok{year}\NormalTok{(sample}\SpecialCharTok{$}\NormalTok{date)))) \{}
    
    \FunctionTok{cat}\NormalTok{(}\StringTok{"YEAR "}\NormalTok{, year,}\StringTok{" : {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    
    \CommentTok{\# Los puntos de cada año}
\NormalTok{    points }\OtherTok{=} \FunctionTok{filter}\NormalTok{(sample,}\FunctionTok{year}\NormalTok{(date)}\SpecialCharTok{==}\NormalTok{year)  }
\NormalTok{    points\_WGS84 }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(points,}\AttributeTok{crs=}\StringTok{"WGS84"}\NormalTok{)}
    
    \CommentTok{\# Consulta a la api para obtener todo los valores del año}
\NormalTok{    daily\_single\_ag }\OtherTok{\textless{}{-}} \FunctionTok{get\_power}\NormalTok{(}
      \AttributeTok{community =} \StringTok{"ag"}\NormalTok{,}
      \AttributeTok{lonlat =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{8}\NormalTok{,}\FloatTok{35.5}\NormalTok{,}\SpecialCharTok{{-}}\FloatTok{1.5}\NormalTok{,}\DecValTok{39}\NormalTok{),  }\CommentTok{\# Límites de Andalucía}
      \AttributeTok{pars =} \FunctionTok{c}\NormalTok{(}\StringTok{"T2M"}\NormalTok{,}\StringTok{"GWETTOP"}\NormalTok{, }\StringTok{"RH2M"}\NormalTok{,}\StringTok{"WD10M"}\NormalTok{,}\StringTok{"WS10M"}\NormalTok{,}\StringTok{"PRECTOTCORR"}\NormalTok{),}
      \AttributeTok{dates =} \FunctionTok{paste0}\NormalTok{(year,}\FunctionTok{c}\NormalTok{(}\StringTok{"{-}01{-}01"}\NormalTok{,}\StringTok{"{-}12{-}31"}\NormalTok{)),}
      \AttributeTok{temporal\_api =} \StringTok{"daily"}\NormalTok{)}
    
    \CommentTok{\# Identificador}
\NormalTok{    daily\_single\_ag}\SpecialCharTok{$}\NormalTok{clim\_id }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(daily\_single\_ag)}
\NormalTok{    points}\SpecialCharTok{$}\NormalTok{clim\_id }\OtherTok{=} \ConstantTok{NA} \CommentTok{\# Inicializo el identificador}
    
    \ControlFlowTok{for}\NormalTok{ (day }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(points}\SpecialCharTok{$}\NormalTok{date)) \{}
      
\NormalTok{      points\_day }\OtherTok{=}\NormalTok{ points}\SpecialCharTok{$}\NormalTok{date}\SpecialCharTok{==}\NormalTok{day}
      
      \CommentTok{\# Seleccionar un día}
\NormalTok{      clim\_day  }\OtherTok{\textless{}{-}} \FunctionTok{filter}\NormalTok{(daily\_single\_ag,YYYYMMDD}\SpecialCharTok{==}\NormalTok{day) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\AttributeTok{x =}\NormalTok{ LON,}\AttributeTok{y =}\NormalTok{ LAT,}\AttributeTok{clim\_id=}\NormalTok{ clim\_id)}
      
\NormalTok{      id\_rast\_day }\OtherTok{=} \FunctionTok{rast}\NormalTok{(}\FunctionTok{rasterFromXYZ}\NormalTok{(clim\_day,}\AttributeTok{crs=}\StringTok{"WGS84"}\NormalTok{)) }\CommentTok{\# Se crea el raster con los identificadores}
      
\NormalTok{      points[points\_day,]}\SpecialCharTok{$}\NormalTok{clim\_id }\OtherTok{\textless{}{-}}\NormalTok{ terra}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(id\_rast\_day,points\_WGS84[points\_day,])}\SpecialCharTok{$}\NormalTok{clim\_id }\CommentTok{\# Se asocia a cada registro de la muestra el identificador correspondiente}
\NormalTok{    \}}
    
    \CommentTok{\# Haciendo uso del identificador se asocian todas las variables meteorológicas correspondientes a cada registro}
\NormalTok{    points }\OtherTok{\textless{}{-}}\NormalTok{ points }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{select}\NormalTok{(daily\_single\_ag, }\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(LAT,LON,DOY,YYYYMMDD)),}
                \AttributeTok{by=}\FunctionTok{join\_by}\NormalTok{(clim\_id)) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{clim\_id) }
    
\NormalTok{    dataset }\OtherTok{=} \FunctionTok{rbind}\NormalTok{(dataset,points)}
\NormalTok{  \}}
  
  \FunctionTok{rm}\NormalTok{(points,points\_WGS84,daily\_single\_ag,clim\_day,id\_rast\_day,points\_day,day,year,andalucia\_WGS84)}
  
  
  \CommentTok{\# Variables topográficas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Asignando variables topográficas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  elev }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_raw/topograficas/elevacion.tif"}\NormalTok{)}
\NormalTok{  pend }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_raw/topograficas/pendiente.tif"}\NormalTok{)}
\NormalTok{  orient }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_raw/topograficas/orientacion.tif"}\NormalTok{)}
\NormalTok{  curv }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_raw/topograficas/curvatura.tif"}\NormalTok{)}
  
  \CommentTok{\# Es necesario pasarlas a numeric para poder trabajar con ellas y extraer los valores}
\NormalTok{  pend }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(pend)}
\NormalTok{  orient }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(orient)}
\NormalTok{  curv }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(curv)}
  
  \CommentTok{\# Se extraen los valores de cada una de las capas}
\NormalTok{  var\_topograficas }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{elevacion =}\NormalTok{ elev,}\AttributeTok{pendiente =}\NormalTok{ pend,}\AttributeTok{orientacion =}\NormalTok{ orient,}\AttributeTok{curvatura =}\NormalTok{ curv)}
  
\NormalTok{  points\_topograficas }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(var\_topograficas,}\ControlFlowTok{function}\NormalTok{(x) terra}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(x,dataset))[}\DecValTok{2}\NormalTok{,] }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as\_tibble}\NormalTok{()}
  
\NormalTok{  dataset }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(dataset,points\_topograficas)}
  
  \FunctionTok{rm}\NormalTok{(elev,pend,orient,curv,var\_topograficas,points\_topograficas)}
  
  
  \CommentTok{\# Variables antropológicas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Asignando variables antropológicas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \DocumentationTok{\#\# Para optimizar el cálculo evitando que se repitan cálculos si hay puntos repetidos:!!}
\NormalTok{  dataset\_geoms }\OtherTok{\textless{}{-}}\NormalTok{ dataset }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{group\_by}\NormalTok{(geometry) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{group\_keys}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{st\_sf}\NormalTok{(}\AttributeTok{crs =} \FunctionTok{st\_crs}\NormalTok{(dataset)) }
  
  \DocumentationTok{\#\#\# Carreteras: {-}{-}{-}{-}}
\NormalTok{  carreteras }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/RedCarreteras/09\_14\_RedCarreteras.shp"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_union}\NormalTok{()}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_carretera }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,carreteras) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{()      }\CommentTok{\# metres}

  \FunctionTok{rm}\NormalTok{(carreteras)}
  
  \DocumentationTok{\#\#\# Poblaciones: {-}{-}{-}{-}}
\NormalTok{  poblaciones }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Poblaciones/07\_01\_Poblaciones.shp"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_union}\NormalTok{()}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_poblacion }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,poblaciones) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{()    }\CommentTok{\# metres}
  
  \FunctionTok{rm}\NormalTok{(poblaciones)}
  
  \DocumentationTok{\#\#\# Linea Eléctrica: {-}{-}{-}{-}}
\NormalTok{  linea\_electrica }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/LineaElectrica/10\_14\_LineaElectrica.shp"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_union}\NormalTok{()}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_electr }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,linea\_electrica) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{() }\CommentTok{\# metres}
  
  \FunctionTok{rm}\NormalTok{(linea\_electrica)}
  
  \DocumentationTok{\#\#\# Ferrocarril: {-}{-}{-}{-}}
\NormalTok{  ferrocarril }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Ferrocarril/09\_21\_Ferrocarril.shp"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_union}\NormalTok{()}
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_ferrocarril }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,ferrocarril) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{()}
  
  \FunctionTok{rm}\NormalTok{(ferrocarril)}
  
  \DocumentationTok{\#\#\# Camino / Via: {-}{-}{-}{-}}
\NormalTok{  camino }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Camino/09\_19\_Camino.shp"}\NormalTok{) }
\NormalTok{  viapec }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Camino/09\_22\_ViasPecuarias.shp"}\NormalTok{) }
  
\NormalTok{  camino\_viapec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{st\_geometry}\NormalTok{(camino),}\FunctionTok{st\_geometry}\NormalTok{(viapec))}
  \FunctionTok{rm}\NormalTok{(camino,viapec)}
  
\NormalTok{  camino\_viapec }\OtherTok{\textless{}{-}} \FunctionTok{st\_union}\NormalTok{(camino\_viapec)}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_camino }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,camino\_viapec) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{()}
  
  \FunctionTok{rm}\NormalTok{(camino\_viapec)}
  
  \DocumentationTok{\#\#\# Sendero / Vía Verde / CarrilBici: {-}{-}{-}{-}}
\NormalTok{  viaverde }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Sendero\_ViaVerde/09\_24\_ViaVerde.shp"}\NormalTok{) }
\NormalTok{  sendero }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/sendero\_ViaVerde/09\_20\_Sendero.shp"}\NormalTok{) }
\NormalTok{  carrilbic }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/sendero\_ViaVerde/09\_23\_CarrilBici.shp"}\NormalTok{)}
  
\NormalTok{  sendero\_viaverde\_carrilbici }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{st\_geometry}\NormalTok{(viaverde),}\FunctionTok{st\_geometry}\NormalTok{(sendero),}\FunctionTok{st\_geometry}\NormalTok{(carrilbic)) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_union}\NormalTok{()}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_sendero }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,sendero\_viaverde\_carrilbici) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{()}
  
  \FunctionTok{rm}\NormalTok{(sendero,sendero\_viaverde\_carrilbici,viaverde,carrilbic)}
  
  \DocumentationTok{\#\#\# ENP: {-}{-}{-}{-}}
\NormalTok{  enp1 }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/ENP/11\_07\_Enp\_FiguraProteccion.shp"}\NormalTok{ )}
\NormalTok{  enp2 }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/antropologicas/ENP/11\_07\_Enp\_RegimenProteccion.shp"}\NormalTok{)}
  
\NormalTok{  enp }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{st\_geometry}\NormalTok{(enp1),}\FunctionTok{st\_geometry}\NormalTok{(enp2)) }\SpecialCharTok{|\textgreater{}}  \FunctionTok{st\_union}\NormalTok{()}
\NormalTok{  enp\_sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_sf}\NormalTok{(enp)}
  
  \CommentTok{\# Se rasteriza para aumentar la eficiencia computacional}
\NormalTok{  enp\_rast }\OtherTok{\textless{}{-}} \FunctionTok{rasterize}\NormalTok{(enp\_sf,}
                        \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_raw/topograficas/pendiente.tif"}\NormalTok{), }\CommentTok{\# Modelo}
                        \AttributeTok{background =} \DecValTok{0}\NormalTok{)}
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{enp}\OtherTok{=}\NormalTok{ terra}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(enp\_rast,dataset\_geoms)[,}\DecValTok{2}\NormalTok{]}
  
  \FunctionTok{rm}\NormalTok{(enp,enp1,enp2,enp\_sf,enp\_rast)}
  
  \DocumentationTok{\#\#\# Uso Suelo: {-}{-}{-}{-}}
  \CommentTok{\# Inicialmente se ha rasterizado para aumentar la eficiencia computacional}
  \CommentTok{\# UsoSuelo \textless{}{-} read\_sf("data\_raw/antropologicas/UsoSuelo/06\_01\_UsoSuelo.shp")}
  \CommentTok{\# UsoSuelo\_rast \textless{}{-} rasterize(UsoSuelo,}
  \CommentTok{\#                            rast("data\_raw/topograficas/pendiente.tif"), \# Modelo}
  \CommentTok{\#                            field="cod\_uso")}
  
\NormalTok{  UsoSuelo\_rast }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(}\StringTok{"data\_cleaning/uso\_suelo\_rast.tiff"}\NormalTok{)}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{uso\_suelo }\OtherTok{=}\NormalTok{ terra}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(UsoSuelo\_rast,dataset\_geoms)[,}\DecValTok{2}\NormalTok{]}
  
  \CommentTok{\# Hidrográficas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Asignando variables hidrográficas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \DocumentationTok{\#\#\# Distancia a ríos: {-}{-}{-}{-}}
\NormalTok{  rios }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(}\StringTok{"data\_raw/hidrograficas/Rios\_Espana.shp"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(dataset)) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_crop}\NormalTok{(}\AttributeTok{xmin =} \FloatTok{100394.4}\NormalTok{, }\CommentTok{\# Esto se hace solo para no tener que considerar todo el file y que sea más eficiente computacionalmente}
            \AttributeTok{ymin =} \FloatTok{3976888.6}\NormalTok{,}
            \AttributeTok{xmax =} \FloatTok{690000.8}\NormalTok{,}
            \AttributeTok{ymax =} \FloatTok{4350000.0}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_union}\NormalTok{()}
  
\NormalTok{  dataset\_geoms}\SpecialCharTok{$}\NormalTok{dist\_rios }\OtherTok{\textless{}{-}} \FunctionTok{st\_distance}\NormalTok{(dataset\_geoms,rios) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{as.numeric}\NormalTok{() }\CommentTok{\# metres}
  
  \FunctionTok{rm}\NormalTok{(rios)}
  
  \DocumentationTok{\#\#  Se vuelven a desagrupar los registros y se le asigna a cada registro los valores correspondientes calculados!!}
\NormalTok{  dataset }\OtherTok{\textless{}{-}}\NormalTok{ dataset }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{st\_join}\NormalTok{(dataset\_geoms,}\AttributeTok{left =} \ConstantTok{TRUE}\NormalTok{) }\CommentTok{\# Es un left join espacial}
  
  \CommentTok{\# Demográficas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Asignando variables demográficas...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \DocumentationTok{\#\#\# Población y densidad de población: {-}{-}{-}{-}}
  
\NormalTok{  poblacion }\OtherTok{\textless{}{-}} \FunctionTok{read\_csv2}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Población/poblacion\_municipios.txt"}\NormalTok{,}
                         \AttributeTok{locale=}\FunctionTok{locale}\NormalTok{(}\AttributeTok{decimal\_mark =} \StringTok{","}\NormalTok{),}
                         \AttributeTok{col\_select =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{,}\AttributeTok{col\_types =} \StringTok{"ccifn"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Valor=}\FunctionTok{as.integer}\NormalTok{(}\FunctionTok{round}\NormalTok{(Valor))) }\CommentTok{\# Por algún motivo aparecen decimales}
  
  
\NormalTok{  area\_municipios }\OtherTok{\textless{}{-}} \FunctionTok{read\_csv2}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Población/extension\_municipal.txt"}\NormalTok{,}
                               \AttributeTok{locale=}\FunctionTok{locale}\NormalTok{(}\AttributeTok{decimal\_mark =} \StringTok{","}\NormalTok{),}
                               \AttributeTok{col\_select =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\AttributeTok{col\_types =} \StringTok{"fffffn"}\NormalTok{)}

\NormalTok{  area\_municipios }\OtherTok{\textless{}{-}}\NormalTok{ area\_municipios }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(CODIGO\_INE3)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{select}\NormalTok{(CODIGO\_INE3,Valor) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{rename}\NormalTok{(}\StringTok{"Area"} \OtherTok{=} \StringTok{"Valor"}\NormalTok{)}
  
  \CommentTok{\# Se calcula la densidad de población anual como el cociente del número de habitantes entre la extensión del municipio}
\NormalTok{  dens\_poblacion }\OtherTok{\textless{}{-}}\NormalTok{ poblacion }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Medida) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{rename}\NormalTok{(}\StringTok{"Poblacion"} \OtherTok{=} \StringTok{"Valor"}\NormalTok{,}
           \StringTok{"Municipio"} \OtherTok{=} \StringTok{"Lugar de residencia"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{left\_join}\NormalTok{(area\_municipios,}
              \FunctionTok{join\_by}\NormalTok{(}\StringTok{"CODIGO\_INE3"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{dens\_poblacion =}\NormalTok{ Poblacion}\SpecialCharTok{/}\NormalTok{Area) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Area)}
  
\NormalTok{  municipios }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_munic}\NormalTok{(}\AttributeTok{epsg =} \DecValTok{4258}\NormalTok{,}\AttributeTok{region =} \StringTok{"Andalucía"}\NormalTok{)}
  
\NormalTok{  municipios }\OtherTok{\textless{}{-}}\NormalTok{ municipios }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{st\_transform}\NormalTok{(crs\_reference)}
  
  \CommentTok{\# Se asocia cada observacion su código de municipio correspondiente }
  
\NormalTok{  num\_mun }\OtherTok{=} \FunctionTok{st\_intersects}\NormalTok{(dataset,municipios) }
  
  \CommentTok{\# Se eliminan las observaciones que no están en ningún municipio }
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(num\_mun,}\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{))) \{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Eliminamos las observaciones:}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}\FunctionTok{which}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(num\_mun,}\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)))}
\NormalTok{    dataset }\OtherTok{=}\NormalTok{ dataset[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(num\_mun,}\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)),]}
\NormalTok{  \}}
  
\NormalTok{  dataset}\SpecialCharTok{$}\NormalTok{cod\_municipio }\OtherTok{\textless{}{-}}\NormalTok{ municipios[}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{st\_intersects}\NormalTok{(dataset,municipios)),]}\SpecialCharTok{$}\NormalTok{LAU\_CODE}
  
\NormalTok{  dataset }\OtherTok{\textless{}{-}}\NormalTok{ dataset }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{left\_join}\NormalTok{(dens\_poblacion,}
              \FunctionTok{join\_by}\NormalTok{(cod\_municipio}\SpecialCharTok{==}\NormalTok{CODIGO\_INE3,YEAR}\SpecialCharTok{==}\NormalTok{Anual)) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{rename}\NormalTok{(}\StringTok{"municipio"} \OtherTok{=} \StringTok{"Municipio"}\NormalTok{,}
           \StringTok{"poblacion"} \OtherTok{=} \StringTok{"Poblacion"}\NormalTok{)}
  
  \CommentTok{\# Vegetación {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Asignando variables de vegetación...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \DocumentationTok{\#\#\# NDVI {-}{-}{-}{-}}
\NormalTok{  dataset}\SpecialCharTok{$}\NormalTok{NDVI }\OtherTok{=} \ConstantTok{NA}
  
  \ControlFlowTok{for}\NormalTok{ (YEAR }\ControlFlowTok{in} \DecValTok{2002}\SpecialCharTok{:}\DecValTok{2022}\NormalTok{) \{}
    \ControlFlowTok{for}\NormalTok{ (MONTH }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{) \{}
\NormalTok{      MM }\OtherTok{=} \FunctionTok{str\_pad}\NormalTok{(MONTH,}\DecValTok{2}\NormalTok{,}\StringTok{"left"}\NormalTok{,}\AttributeTok{pad =} \StringTok{"0"}\NormalTok{)}
\NormalTok{      YY }\OtherTok{=} \FunctionTok{substr}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(YEAR),}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)}
      \CommentTok{\# if (as.numeric(YY)\textless{}=01) \{}
      \CommentTok{\#   ruta \textless{}{-} paste0("data\_raw/vegetacion/",YEAR,"NOAAVHMEDMNDVI/InfGeografica/InfRaster/TIF/NOAAVH\_",YY,MM,"01\_Andaluz\_MEDMndvi.tif")}
      \CommentTok{\# \} else }
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(YY)}\SpecialCharTok{\textless{}=}\DecValTok{06}\NormalTok{) \{}
\NormalTok{        ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YEAR,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/TIFF/TERMOD\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi.tif"}\NormalTok{)}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(YY)}\SpecialCharTok{\textless{}=}\DecValTok{11}\NormalTok{) \{}
\NormalTok{        ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YEAR,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/TIF/TERMOD\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi.tif"}\NormalTok{)}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(YY)}\SpecialCharTok{\textless{}=}\DecValTok{21}\NormalTok{) \{}
\NormalTok{        ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YEAR,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/TIFF/termod\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi.tif"}\NormalTok{)}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YEAR,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/COG/termod\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi\_COG.tif"}\NormalTok{)}
\NormalTok{      \}}
      
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(ruta)) \{}
        \FunctionTok{cat}\NormalTok{(YEAR,MONTH,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \CommentTok{\# Observaciones en ese mes y año}
\NormalTok{        isMY }\OtherTok{=}\NormalTok{ dataset}\SpecialCharTok{$}\NormalTok{YEAR}\SpecialCharTok{==}\NormalTok{YEAR }\SpecialCharTok{\&}\NormalTok{ dataset}\SpecialCharTok{$}\NormalTok{MM}\SpecialCharTok{==}\NormalTok{MONTH}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(isMY)) \{}
\NormalTok{          NDVI\_rast }\OtherTok{=} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{rast}\NormalTok{(ruta))}
          \ControlFlowTok{if}\NormalTok{ (MONTH}\SpecialCharTok{==}\DecValTok{4} \SpecialCharTok{\&}\NormalTok{ YEAR}\SpecialCharTok{==}\DecValTok{2011}\NormalTok{)\{}
            \CommentTok{\# Ese archivo viene defectuoso y se le asigna el CRS de los otros archivos del mismo año (todos los demás del año tienen el mismo)}
            \FunctionTok{crs}\NormalTok{(NDVI\_rast) }\OtherTok{=} \StringTok{"PROJCRS[}\SpecialCharTok{\textbackslash{}"}\StringTok{WGS 84 / UTM zone 30N}\SpecialCharTok{\textbackslash{}"}\StringTok{,}\SpecialCharTok{\textbackslash{}n}\StringTok{    BASEGEOGCRS[}\SpecialCharTok{\textbackslash{}"}\StringTok{WGS 84}\SpecialCharTok{\textbackslash{}"}\StringTok{,}\SpecialCharTok{\textbackslash{}n}\StringTok{        DATUM[}\SpecialCharTok{\textbackslash{}"}\StringTok{World Geodetic System 1984}\SpecialCharTok{\textbackslash{}"}\StringTok{,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ELLIPSOID[}\SpecialCharTok{\textbackslash{}"}\StringTok{WGS 84}\SpecialCharTok{\textbackslash{}"}\StringTok{,6378137,298.257223563,}\SpecialCharTok{\textbackslash{}n}\StringTok{                LENGTHUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{metre}\SpecialCharTok{\textbackslash{}"}\StringTok{,1]]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        PRIMEM[}\SpecialCharTok{\textbackslash{}"}\StringTok{Greenwich}\SpecialCharTok{\textbackslash{}"}\StringTok{,0,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ANGLEUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{degree}\SpecialCharTok{\textbackslash{}"}\StringTok{,0.0174532925199433]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,4326]],}\SpecialCharTok{\textbackslash{}n}\StringTok{    CONVERSION[}\SpecialCharTok{\textbackslash{}"}\StringTok{UTM zone 30N}\SpecialCharTok{\textbackslash{}"}\StringTok{,}\SpecialCharTok{\textbackslash{}n}\StringTok{        METHOD[}\SpecialCharTok{\textbackslash{}"}\StringTok{Transverse Mercator}\SpecialCharTok{\textbackslash{}"}\StringTok{,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,9807]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        PARAMETER[}\SpecialCharTok{\textbackslash{}"}\StringTok{Latitude of natural origin}\SpecialCharTok{\textbackslash{}"}\StringTok{,0,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ANGLEUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{degree}\SpecialCharTok{\textbackslash{}"}\StringTok{,0.0174532925199433],}\SpecialCharTok{\textbackslash{}n}\StringTok{            ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,8801]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        PARAMETER[}\SpecialCharTok{\textbackslash{}"}\StringTok{Longitude of natural origin}\SpecialCharTok{\textbackslash{}"}\StringTok{,{-}3,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ANGLEUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{degree}\SpecialCharTok{\textbackslash{}"}\StringTok{,0.0174532925199433],}\SpecialCharTok{\textbackslash{}n}\StringTok{            ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,8802]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        PARAMETER[}\SpecialCharTok{\textbackslash{}"}\StringTok{Scale factor at natural origin}\SpecialCharTok{\textbackslash{}"}\StringTok{,0.9996,}\SpecialCharTok{\textbackslash{}n}\StringTok{            SCALEUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{unity}\SpecialCharTok{\textbackslash{}"}\StringTok{,1],}\SpecialCharTok{\textbackslash{}n}\StringTok{            ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,8805]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        PARAMETER[}\SpecialCharTok{\textbackslash{}"}\StringTok{False easting}\SpecialCharTok{\textbackslash{}"}\StringTok{,500000,}\SpecialCharTok{\textbackslash{}n}\StringTok{            LENGTHUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{metre}\SpecialCharTok{\textbackslash{}"}\StringTok{,1],}\SpecialCharTok{\textbackslash{}n}\StringTok{            ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,8806]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        PARAMETER[}\SpecialCharTok{\textbackslash{}"}\StringTok{False northing}\SpecialCharTok{\textbackslash{}"}\StringTok{,0,}\SpecialCharTok{\textbackslash{}n}\StringTok{            LENGTHUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{metre}\SpecialCharTok{\textbackslash{}"}\StringTok{,1],}\SpecialCharTok{\textbackslash{}n}\StringTok{            ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,8807]]],}\SpecialCharTok{\textbackslash{}n}\StringTok{    CS[Cartesian,2],}\SpecialCharTok{\textbackslash{}n}\StringTok{        AXIS[}\SpecialCharTok{\textbackslash{}"}\StringTok{(E)}\SpecialCharTok{\textbackslash{}"}\StringTok{,east,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ORDER[1],}\SpecialCharTok{\textbackslash{}n}\StringTok{            LENGTHUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{metre}\SpecialCharTok{\textbackslash{}"}\StringTok{,1]],}\SpecialCharTok{\textbackslash{}n}\StringTok{        AXIS[}\SpecialCharTok{\textbackslash{}"}\StringTok{(N)}\SpecialCharTok{\textbackslash{}"}\StringTok{,north,}\SpecialCharTok{\textbackslash{}n}\StringTok{            ORDER[2],}\SpecialCharTok{\textbackslash{}n}\StringTok{            LENGTHUNIT[}\SpecialCharTok{\textbackslash{}"}\StringTok{metre}\SpecialCharTok{\textbackslash{}"}\StringTok{,1]],}\SpecialCharTok{\textbackslash{}n}\StringTok{    USAGE[}\SpecialCharTok{\textbackslash{}n}\StringTok{        SCOPE[}\SpecialCharTok{\textbackslash{}"}\StringTok{Navigation and medium accuracy spatial referencing.}\SpecialCharTok{\textbackslash{}"}\StringTok{],}\SpecialCharTok{\textbackslash{}n}\StringTok{        AREA[}\SpecialCharTok{\textbackslash{}"}\StringTok{Between 6°W and 0°W, northern hemisphere between equator and 84°N, onshore and offshore. Algeria. Burkina Faso. Côte\textquotesingle{} Ivoire (Ivory Coast). Faroe Islands {-} offshore. France. Ghana. Gibraltar. Ireland {-} offshore Irish Sea. Mali. Mauritania. Morocco. Spain. United Kingdom (UK).}\SpecialCharTok{\textbackslash{}"}\StringTok{],}\SpecialCharTok{\textbackslash{}n}\StringTok{        BBOX[0,{-}6,84,0]],}\SpecialCharTok{\textbackslash{}n}\StringTok{    ID[}\SpecialCharTok{\textbackslash{}"}\StringTok{EPSG}\SpecialCharTok{\textbackslash{}"}\StringTok{,32630]]"}
\NormalTok{          \} }
          
\NormalTok{          dataset[isMY,]}\SpecialCharTok{$}\NormalTok{NDVI }\OtherTok{=}\NormalTok{ terra}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(NDVI\_rast,dataset[isMY,])[,}\DecValTok{2}\NormalTok{]}
\NormalTok{        \}}
\NormalTok{      \} }\ControlFlowTok{else}
        \FunctionTok{cat}\NormalTok{(}\StringTok{"No existe: "}\NormalTok{,YEAR,}\StringTok{"{-}"}\NormalTok{,MONTH,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \} }
\NormalTok{  \}}
  
  
  \CommentTok{\# Factores {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# Codificación de las variables categóricas como factores:}
  
\NormalTok{  dataset }\OtherTok{\textless{}{-}}\NormalTok{ dataset }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{enp =} \FunctionTok{as.factor}\NormalTok{(enp),}
           \AttributeTok{orientacion =} \FunctionTok{cut}\NormalTok{(orientacion,}
                             \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\ConstantTok{Inf}\NormalTok{,}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\FloatTok{22.5}\NormalTok{,}\FloatTok{67.5}\NormalTok{,}\FloatTok{112.5}\NormalTok{,}\FloatTok{157.5}\NormalTok{,}\FloatTok{202.5}\NormalTok{,}\FloatTok{247.5}\NormalTok{,}\FloatTok{292.5}\NormalTok{,}\FloatTok{337.5}\NormalTok{,}\DecValTok{360}\NormalTok{),}
                             \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Plano"}\NormalTok{,}\StringTok{"N"}\NormalTok{,}\StringTok{"NE"}\NormalTok{,}\StringTok{"E"}\NormalTok{,}\StringTok{"SE"}\NormalTok{,}\StringTok{"S"}\NormalTok{,}\StringTok{"SW"}\NormalTok{,}\StringTok{"W"}\NormalTok{,}\StringTok{"NW"}\NormalTok{,}\StringTok{"N"}\NormalTok{)),}
           \AttributeTok{WD10M =} \FunctionTok{cut}\NormalTok{(WD10M,}
                       \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{22.5}\NormalTok{,}\FloatTok{67.5}\NormalTok{,}\FloatTok{112.5}\NormalTok{,}\FloatTok{157.5}\NormalTok{,}\FloatTok{202.5}\NormalTok{,}\FloatTok{247.5}\NormalTok{,}\FloatTok{292.5}\NormalTok{,}\FloatTok{337.5}\NormalTok{,}\DecValTok{360}\NormalTok{),}
                       \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"N"}\NormalTok{,}\StringTok{"NE"}\NormalTok{,}\StringTok{"E"}\NormalTok{,}\StringTok{"SE"}\NormalTok{,}\StringTok{"S"}\NormalTok{,}\StringTok{"SW"}\NormalTok{,}\StringTok{"W"}\NormalTok{,}\StringTok{"NW"}\NormalTok{,}\StringTok{"N"}\NormalTok{)),}
           \AttributeTok{uso\_suelo =}\NormalTok{ uso\_suelo }\SpecialCharTok{|\textgreater{}} \FunctionTok{as.character}\NormalTok{() }\SpecialCharTok{|\textgreater{}} \FunctionTok{str\_sub}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{) }\SpecialCharTok{|\textgreater{}} \FunctionTok{as.factor}\NormalTok{()}
\NormalTok{           ) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(YEAR,MM,DD))}
  
  \FunctionTok{return}\NormalTok{(dataset)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Se usa la función definida para asignar las variables explicativas a la
muestra generada:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Se carga la muestra generada en el paso anterior:}
\FunctionTok{load}\NormalTok{(}\StringTok{"salidas\_intermedias/sample\_strat\_2024{-}04{-}26.RData"}\NormalTok{)}

\CommentTok{\# Se eliminan las observaciones que no tienen fecha pues se pueden usar para el estudio}
\NormalTok{sample }\OtherTok{\textless{}{-}} \FunctionTok{na.omit}\NormalTok{(sample)}

\CommentTok{\# Se aplica la función a la muestra }
\NormalTok{dataset }\OtherTok{\textless{}{-}} \FunctionTok{asignar\_variables}\NormalTok{(sample)}

\CommentTok{\# Se almacenan los resultados}
\FunctionTok{save}\NormalTok{(dataset,}\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"salidas\_intermedias/dataset\_strat\_completo"}\NormalTok{,}\FunctionTok{Sys.Date}\NormalTok{(),}\StringTok{".RData"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{depuraciuxf3n-de-la-muestra}{%
\section{Depuración de la muestra}\label{depuraciuxf3n-de-la-muestra}}

En la propia función usada para generar la muestra ya se ajustaron los
tipos de las variables y se codificaron adecuadamente las variables
\emph{WD10M} y \emph{orientacion}. A continuación se estudian los casos
faltantes y finalmente se decide eliminarlos.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Librerías {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan las librerías que se usarán en esta sección}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# Manipulación de datos }
\FunctionTok{library}\NormalTok{(sf) }\CommentTok{\# Vector data}
\FunctionTok{library}\NormalTok{(terra) }\CommentTok{\# Raster data}
\FunctionTok{library}\NormalTok{(mapSpain) }\CommentTok{\# Polígonos de regiones de España}
\FunctionTok{library}\NormalTok{(magrittr) }\CommentTok{\# Operador \%\textless{}\textgreater{}\% }
\FunctionTok{library}\NormalTok{(skimr) }\CommentTok{\# Resumen de datos}

\CommentTok{\# Carga de los datos {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se carga la muestra con todas las variables construida anteriormente}
\FunctionTok{load}\NormalTok{(}\StringTok{"salidas\_intermedias/dataset\_strat\_completo2024{-}04{-}26.RData"}\NormalTok{)}


\CommentTok{\# Codificación variable fire: {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{datos }\OtherTok{\textless{}{-}}\NormalTok{ dataset }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{fire =} \FunctionTok{as.factor}\NormalTok{(fire))}

\CommentTok{\# Análisis de valores perdidos: {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{skimr}\NormalTok{()}
\NormalTok{dataset }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{apply}\NormalTok{(}\DecValTok{1}\NormalTok{,anyNA) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{sum}\NormalTok{() }\CommentTok{\# 200 registros con valores perdidos}

\CommentTok{\# Se observan:}
\CommentTok{\#   8 nas en uso\_suelo}
\CommentTok{\#   32 nas en pendiente}
\CommentTok{\#   36 nas en orientacion}
\CommentTok{\#   32 nas en curvatura}
\CommentTok{\#   85 nas en doblacion y en dist\_poblacion}
\CommentTok{\#   85 nas en NDVI}

\NormalTok{datos1 }\OtherTok{=}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{drop\_na}\NormalTok{()}

\CommentTok{\# Valores perdidos en variables topográficas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{Andalucia }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_ccaa}\NormalTok{(}\AttributeTok{ccaa =} \StringTok{"Andalucía"}\NormalTok{) }\CommentTok{\# Se carga el mapa de Andalucía}
\NormalTok{andalucia\_proj }\OtherTok{\textless{}{-}} \FunctionTok{st\_transform}\NormalTok{(Andalucia,}\FunctionTok{st\_crs}\NormalTok{(dataset)) }\CommentTok{\# Se proyecta al sistema de referencia de los datos}

\CommentTok{\# Mapa de valores perdidos en variables topográficas:}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{st\_geometry}\NormalTok{(andalucia\_proj),}\AttributeTok{reset=}\NormalTok{F)}
\NormalTok{datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(pendiente)}\SpecialCharTok{|} \FunctionTok{is.na}\NormalTok{(orientacion) }\SpecialCharTok{|} \FunctionTok{is.na}\NormalTok{(curvatura)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{st\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{plot}\NormalTok{(}\AttributeTok{pch=}\DecValTok{16}\NormalTok{,}\AttributeTok{col=}\StringTok{"red"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T) }\CommentTok{\# Se encuentran en los límites de Andalucía}

\NormalTok{datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(pendiente)}\SpecialCharTok{|} \FunctionTok{is.na}\NormalTok{(orientacion) }\SpecialCharTok{|} \FunctionTok{is.na}\NormalTok{(curvatura)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{count}\NormalTok{() }\CommentTok{\#53 registros con algún valor perdido entre las variables topográficas}


\CommentTok{\# Valores perdidos en variables demográficas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se observa que los valores perdidos se deben a que los datos no estan disponibles en el conjunto de datos disponible en el INE}
\NormalTok{datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(poblacion)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(Año }\OtherTok{=} \FunctionTok{year}\NormalTok{(date)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(Año,municipio,cod\_municipio)}

\CommentTok{\# Ejemplo:}
\NormalTok{pob }\OtherTok{=} \FunctionTok{read\_csv2}\NormalTok{(}\StringTok{"data\_raw/antropologicas/Población/poblacion\_municipios.txt"}\NormalTok{)[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)] }
\NormalTok{pob }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(CODIGO\_INE3 }\SpecialCharTok{==} \StringTok{"18077"}\NormalTok{) }\CommentTok{\# Datos no disponibles}

\NormalTok{datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(poblacion)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{count}\NormalTok{() }\CommentTok{\# 85 resgistros con valores perdidos en las variables demográficas}

\CommentTok{\# Valores perdidos en uso\_suelo {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{dataset }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(uso\_suelo)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{count}\NormalTok{() }\CommentTok{\# 8 registros con valores perdidos en la variable uso\_suelo}

\NormalTok{dataset }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(uso\_suelo)) }\SpecialCharTok{|\textgreater{}} \FunctionTok{st\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} \FunctionTok{plot}\NormalTok{(}\AttributeTok{pch=}\DecValTok{16}\NormalTok{,}\AttributeTok{col=}\StringTok{"red"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T)}
\CommentTok{\# De nuevo se observa que se encuentran en los límites de Andalucía con la costa}

\CommentTok{\# Valores perdidos en NDVI {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se muestran en el mapa}
\FunctionTok{plot}\NormalTok{(}\FunctionTok{st\_geometry}\NormalTok{(andalucia\_proj),}\AttributeTok{reset=}\NormalTok{F)}
\NormalTok{dataset }\SpecialCharTok{|\textgreater{}} \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(NDVI)) }\SpecialCharTok{|\textgreater{}} \FunctionTok{st\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} \FunctionTok{plot}\NormalTok{(}\AttributeTok{pch=}\DecValTok{16}\NormalTok{,}\AttributeTok{col=}\StringTok{"red"}\NormalTok{,}\AttributeTok{add=}\NormalTok{T) }


\CommentTok{\# Gráfico de NDVI medio cada mes}
\NormalTok{NDVI\_mes }\OtherTok{=}\NormalTok{ datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{mes =} \FunctionTok{month}\NormalTok{(date),}
\NormalTok{         año }\OtherTok{=} \FunctionTok{year}\NormalTok{(date)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(año,mes) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{NDVI\_mes =} \FunctionTok{mean}\NormalTok{(}\FunctionTok{na.omit}\NormalTok{(NDVI))) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{date =} \FunctionTok{dmy}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\DecValTok{01}\NormalTok{,mes,año,}\AttributeTok{sep=}\StringTok{"/"}\NormalTok{)))}
  
\NormalTok{NDVI\_mes }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{date,}\AttributeTok{y=}\NormalTok{NDVI\_mes)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{scale\_x\_date}\NormalTok{(}\AttributeTok{date\_breaks =} \StringTok{"6 month"}\NormalTok{,}\AttributeTok{date\_labels =} \StringTok{"\%y\%b"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{90}\NormalTok{))}

\CommentTok{\# 2008 tiene un NDVI especialmente bajo, puede deberse a numerosos factores:}
\CommentTok{\#   {-} Que efectivamente sea un año especialmente seco}
\CommentTok{\#   {-} Las características de la muestra seleccionada ese año}
\CommentTok{\#   {-} Errores de medición}
\CommentTok{\#   {-} ...}

\CommentTok{\# La mayor parte de los valores perdidos en la variable uso\_suelo son debidos a que el archivo tiff para ese mes no está disponible en la REDIAM. Los meses de los que no se dispone del ráster NDVI son: "2003{-}01", "2003{-}04", "2017{-}02", "2018{-}11", "2020{-}11", "2021{-}12", "2022{-}03" y "2022{-}12".}

\CommentTok{\# Eliminación registros con valores perdidos {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Tras explorar otras opciones finalmente se opta por eliminar los registros}
\CommentTok{\# que contienen valroes perdidos:}
\NormalTok{datos }\OtherTok{=}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{drop\_na}\NormalTok{()}

\CommentTok{\# Almacenamiento del conjunto de datos depurados {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se guarda el conjunto de datos depurados}
\FunctionTok{save}\NormalTok{(datos, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"salidas\_intermedias/datos\_strat\_depurados\_geom\_"}\NormalTok{,}\FunctionTok{Sys.Date}\NormalTok{(),}\StringTok{".RData"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{anuxe1lisis-exploratorio}{%
\section{Análisis exploratorio}\label{anuxe1lisis-exploratorio}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Librerías {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan las librerías que se usarán en esta sección}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# Manipulación de datos }
\FunctionTok{library}\NormalTok{(sf) }\CommentTok{\# Vector data}
\FunctionTok{library}\NormalTok{(terra) }\CommentTok{\# Raster data}
\FunctionTok{library}\NormalTok{(mapSpain) }\CommentTok{\# Polígonos de regiones de España}
\FunctionTok{library}\NormalTok{(magrittr) }\CommentTok{\# Operador \%\textless{}\textgreater{}\% }
\FunctionTok{library}\NormalTok{(skimr) }\CommentTok{\# Resumen de datos}
\FunctionTok{library}\NormalTok{(corrplot) }\CommentTok{\# Gráfico de coorrelaciones}
\FunctionTok{library}\NormalTok{(GGally) }\CommentTok{\# Coordenadas paralelas}
\FunctionTok{library}\NormalTok{(ggpubr) }\CommentTok{\# Función ggarrange}

\CommentTok{\# Carga de los datos {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\FunctionTok{load}\NormalTok{(}\StringTok{"salidas\_intermedias/datos\_strat\_depurados\_geom\_2024{-}05{-}03.RData"}\NormalTok{)}

\CommentTok{\# Resumen numérico {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{  st\_drop\_geometry }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{skim}\NormalTok{(}\AttributeTok{.data\_name =} \StringTok{"datos"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-objetivo}{%
\subsection{Variable objetivo}\label{variable-objetivo}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Distribución temporal {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Mensual:}
\NormalTok{g\_mes }\OtherTok{\textless{}{-}}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# filter(fire==1) \%\textgreater{}\% }
  \FunctionTok{count}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{rename}\NormalTok{(}\StringTok{"mes"} \OtherTok{=} \StringTok{"month(date, label = T)"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mes,}\AttributeTok{y =}\NormalTok{ n,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# theme(axis.text.x = element\_text(angle = 90)) +}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Número de observaciones"}\NormalTok{)}

\NormalTok{g\_mes}

\CommentTok{\# Anual}
\NormalTok{g\_year }\OtherTok{\textless{}{-}}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# filter(fire==1) \%\textgreater{}\% }
  \FunctionTok{count}\NormalTok{(}\FunctionTok{year}\NormalTok{(date),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{rename}\NormalTok{(}\StringTok{"año"} \OtherTok{=} \StringTok{"year(date)"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ año,}\AttributeTok{y =}\NormalTok{ n,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks=}\DecValTok{2002}\SpecialCharTok{:}\DecValTok{2022}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{se=}\NormalTok{F,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{fire),}\AttributeTok{alpha=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\FunctionTok{c}\NormalTok{(}\StringTok{"darkblue"}\NormalTok{,}\StringTok{"darkred"}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Año"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Número de observaciones"}\NormalTok{)}
\NormalTok{g\_year}

\CommentTok{\# En 2007 no se han generado observaciones positivas}
\CommentTok{\# Causa: En el shapefile que contiene los incendios producidos en 2007 solo hay 4 observaciones y ninguna tenía la fecha, por lo que estas no han podido utilizarse}

\CommentTok{\# Valores muy bajos en 2008 y 2010, revisar}
\CommentTok{\# 2010: correcto, en el archivo con los polígonos de incendios en 2010 solo hay 26 observaciones}
\CommentTok{\# 2008: en el archivo relativo a ese año hay 37 observaciones, pero 11 de ellas no tienen la fecha de inicio, por lo que no se han podido utilizar}

\CommentTok{\# Día de la semana}
\NormalTok{g\_dia }\OtherTok{\textless{}{-}}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# filter(fire==1) \%\textgreater{}\% }
  \FunctionTok{count}\NormalTok{(}\FunctionTok{weekdays}\NormalTok{(date),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{rename}\NormalTok{(}\StringTok{"dia"} \OtherTok{=} \StringTok{"weekdays(date)"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dia,}\AttributeTok{y =}\NormalTok{ n,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{limits=}\FunctionTok{c}\NormalTok{(}\StringTok{"lunes"}\NormalTok{, }\StringTok{"martes"}\NormalTok{, }\StringTok{"miércoles"}\NormalTok{, }\StringTok{"jueves"}\NormalTok{, }\StringTok{"viernes"}\NormalTok{, }\StringTok{"sábado"}\NormalTok{, }\StringTok{"domingo"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{45}\NormalTok{, }\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{)) }\SpecialCharTok{+}
 \CommentTok{\# geom\_smooth(se=F) +}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Día"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Número de observaciones"}\NormalTok{)}
\NormalTok{g\_dia}

\CommentTok{\# Para mostrar los tres gráficos juntos}
\FunctionTok{ggarrange}\NormalTok{(g\_dia,g\_mes,g\_year,}\AttributeTok{ncol=}\DecValTok{1}\NormalTok{,}\AttributeTok{common.legend =}\NormalTok{ T,}\AttributeTok{legend =} \StringTok{"bottom"}\NormalTok{)}

\CommentTok{\# Distribución temporal {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan los polígonos de las provincias}
\NormalTok{and }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_ccaa}\NormalTok{(}\AttributeTok{ccaa =} \StringTok{"Andalucía"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos))}
\NormalTok{prov }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_prov}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(nuts2.name}\SpecialCharTok{==}\StringTok{"Andalucía"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos))}

\CommentTok{\# Casos positivos}
\NormalTok{g1 }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(fire}\SpecialCharTok{==}\DecValTok{1}\NormalTok{),}\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{,}\AttributeTok{col=}\StringTok{"red"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de casos positivos"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\CommentTok{\# Casos negativos}
\NormalTok{g0 }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(fire}\SpecialCharTok{==}\DecValTok{0}\NormalTok{),}\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{,}\AttributeTok{col=}\StringTok{"blue"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de casos negativos"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\CommentTok{\# Ambos gráficos juntos:}
\FunctionTok{ggarrange}\NormalTok{(g1,g0,}\AttributeTok{nrow=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{anuxe1lisis-univariantes}{%
\subsection{Análisis univariantes}\label{anuxe1lisis-univariantes}}

\hypertarget{t2m}{%
\subsubsection*{T2M}\label{t2m}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{T2M),}\AttributeTok{size =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de T2M por mes"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

Las temperaturas más elevadas se encuentran en el interior.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{AVG\_T2M =} \FunctionTok{mean}\NormalTok{(T2M),}
            \AttributeTok{Mes =} \StringTok{\textasciigrave{}}\AttributeTok{month(date, label = T)}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Mes,}\AttributeTok{y=}\NormalTok{AVG\_T2M,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()  }
  \CommentTok{\# + theme(axis.text.x = element\_text(angle = 45, vjust = 0.5, hjust=0.5))}
\end{Highlighting}
\end{Shaded}

En prácticamente todos los meses, la media de temperaturas en las
observaciones positivas es mayor que en las observaciones negativas. Las
temperaturas son más altas en los meses de verano, como cabía esperar.

\hypertarget{rh2m}{%
\subsubsection*{RH2M}\label{rh2m}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{RH2M),}\AttributeTok{size =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{F)) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de RH2M por mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

La humedad del aire es mayor en las de costa. Las zonas más secas se
encuentran en las zonas de interior del norte de Andalucía.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{AVG\_RH2M =} \FunctionTok{mean}\NormalTok{(RH2M),}
            \AttributeTok{Mes =} \StringTok{\textasciigrave{}}\AttributeTok{month(date, label = T)}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Mes,}\AttributeTok{y=}\NormalTok{AVG\_RH2M,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()  }
  \CommentTok{\# + theme(axis.text.x = element\_text(angle = 45, vjust = 0.5, hjust=0.5))}
\end{Highlighting}
\end{Shaded}

En prácticamente todos los meses, la humedad del aire media entre las
observaciones positivas es menor que en las observaciones negativas. La
humedad del aire disminuye significativamente en verano.

\hypertarget{gwettop}{%
\subsubsection*{GWETTOP}\label{gwettop}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{GWETTOP),}\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{F)) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de GWETTOP por mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

Las zonas con mayor humedad superficial de suelo son las que se
encuentran en la costa mediterránea. Las zonas con un suelo más seco son
las que se encuentran al norte de la cuenca el Guadalquivir, destacando
la provincia de Huelva (hay que tener en cuenta que también es una zona
en la que hay muchos incendios, la mayoría de los cuales se produce en
verano, por lo que hay una gran concentración de observaciones durante
el periodo estival, lo que podría influir en el hecho de que se observen
tantas observaciones con valores tan bajos de la humedad superficial de
suelo).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{AVG\_GWETTOP =} \FunctionTok{mean}\NormalTok{(GWETTOP),}
            \AttributeTok{Mes =} \StringTok{\textasciigrave{}}\AttributeTok{month(date, label = T)}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Mes,}\AttributeTok{y=}\NormalTok{AVG\_GWETTOP,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()  }
\end{Highlighting}
\end{Shaded}

En general, la humedad superficial de suelo media entre los casos
positivos es inferior que entre los casos negativos. Esto es
especialmente evidendente entre los meses de primavera y otoño. En los
meses de invierno esto no está tan claro, incluso parece revertirse la
tendencia.

\hypertarget{ws10m}{%
\subsubsection*{WS10M}\label{ws10m}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{WS10M,}\AttributeTok{alpha=}\NormalTok{WS10M,}\AttributeTok{size=}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(WS10M}\SpecialCharTok{\textless{}}\FloatTok{7.5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\FloatTok{1.2}\NormalTok{)))) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{))}\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de WS10M por mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Los valores más elevados de la velocidad del viento a 10m de altura se
dan en las zonas costeras.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{AVG\_WS10M =} \FunctionTok{mean}\NormalTok{(WS10M),}
            \AttributeTok{Mes =} \StringTok{\textasciigrave{}}\AttributeTok{month(date, label = T)}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Mes,}\AttributeTok{y=}\NormalTok{AVG\_WS10M,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()  }
\end{Highlighting}
\end{Shaded}

En todos los meses, los valores medios de la velocidad del viento a 10m
sobre la superficie son significativamente mayores en las observaciones
positivas.

\hypertarget{wd10m}{%
\subsubsection*{WD10M}\label{wd10m}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{WD10M),}\AttributeTok{size =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{))}\SpecialCharTok{+} 
  \CommentTok{\# scale\_color\_stepsn(colours = rainborainbpw(8,rev=T)) +}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de WD10M por mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{color =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_viridis\_d}\NormalTok{(}\AttributeTok{option=}\StringTok{"turbo"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Quisiera tener la dirección mayoritaria por mes y si hay incendio o no }
\NormalTok{mode }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{ }\FunctionTok{names}\NormalTok{(}\FunctionTok{which.max}\NormalTok{(}\FunctionTok{table}\NormalTok{(x))) \}}

\NormalTok{datos\_mode\_WD10M }\OtherTok{=}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{mode\_WD10M =} \FunctionTok{mode}\NormalTok{(WD10M)) }

\FunctionTok{tibble}\NormalTok{(}\AttributeTok{mes =}\NormalTok{ datos\_mode\_WD10M[datos\_mode\_WD10M}\SpecialCharTok{$}\NormalTok{fire}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{],}
       \AttributeTok{fire1 =}\NormalTok{ datos\_mode\_WD10M[datos\_mode\_WD10M}\SpecialCharTok{$}\NormalTok{fire}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{],}
       \AttributeTok{fire0 =}\NormalTok{ datos\_mode\_WD10M[datos\_mode\_WD10M}\SpecialCharTok{$}\NormalTok{fire}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\DecValTok{3}\NormalTok{]) }

\CommentTok{\# No parece aportar ninguna información relevante}
\end{Highlighting}
\end{Shaded}

\hypertarget{prectotcorr}{%
\subsubsection*{PRECTOTCORR}\label{prectotcorr}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{PRECTOTCORR,}\AttributeTok{size=}\NormalTok{PRECTOTCORR,}\AttributeTok{alpha=}\NormalTok{PRECTOTCORR)) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{F)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de PRECTOTCORR por mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

En la gran mayoría de las observaciones no se han observado
precipitaciones. Se observan algunos valores positivos de
precipitaciones distribuidos por el territorio Andaluz, alcanzándose los
máximos en observaciones localizadas ne las coordilleras béticas.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{AVG\_PRECTOTCORR =} \FunctionTok{mean}\NormalTok{(PRECTOTCORR),}
            \AttributeTok{Mes =} \StringTok{\textasciigrave{}}\AttributeTok{month(date, label = T)}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Mes,}\AttributeTok{y=}\NormalTok{AVG\_PRECTOTCORR,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()  }
\end{Highlighting}
\end{Shaded}

Se observa una clara diferencia en la media mensual de precipitaciones
en ambas clases en todos los meses, siendo mucho mayores entre las
observaciones negativas. En los meses de verano esto sigue siendo
cierto, si bien las diferencias se suavizan significativamente, ya que
en ambos clases las precipitaciones son reducidas.

\hypertarget{ndvi}{%
\subsubsection*{NDVI}\label{ndvi}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{NDVI),}\AttributeTok{size =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de NDVI por mes"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

Los valores más elevados del NDVI se encuentran en el norte de la
comunidad (Sierra Morena y Sierra de Aracena) y en la zona sur-centro.
Los valores son especialmente elevados en la Sierra de Grazalema y en
las marismas del Guadalquivir y especialmente bajos en el este de la
comunidad (Almería).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\NormalTok{T),fire) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{AVG\_NDVI =} \FunctionTok{mean}\NormalTok{(NDVI),}
            \AttributeTok{Mes =} \StringTok{\textasciigrave{}}\AttributeTok{month(date, label = T)}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Mes,}\AttributeTok{y=}\NormalTok{AVG\_NDVI,}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\StringTok{"dodge"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()    }
  \CommentTok{\# theme(axis.text.x = element\_text(angle = 45, vjust = 0.5, hjust=0.5))}
\end{Highlighting}
\end{Shaded}

El valor del NDVI disminuye en los meses de verano y alcanza su máximo
en los meses de invierno. No se observa claramente una relación entre el
NDVI y la clase de la observación en la muestra.

\hypertarget{poblacion}{%
\subsubsection*{poblacion}\label{poblacion}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{poblacion,}\AttributeTok{size =}\NormalTok{ poblacion,}\AttributeTok{alpha=}\NormalTok{poblacion}\SpecialCharTok{/}\FunctionTok{median}\NormalTok{(poblacion))) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de poblacion"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{theme\_minimal}\NormalTok{() }

\FunctionTok{by}\NormalTok{(datos}\SpecialCharTok{$}\NormalTok{poblacion,datos}\SpecialCharTok{$}\NormalTok{fire,summary)}
\end{Highlighting}
\end{Shaded}

En la gran mayoría del territorio se observan niveles de población
inferiores a 20.000 habitantes por municipio. Destacan las capitales de
provincia por tener valores significativamente más elevados.

\hypertarget{dens_poblacion}{%
\subsubsection*{dens\_poblacion}\label{dens_poblacion}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dens\_poblacion, }\AttributeTok{size=}\NormalTok{ dens\_poblacion, }\AttributeTok{alpha=}\NormalTok{dens\_poblacion)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dens\_poblacion"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\FunctionTok{by}\NormalTok{(datos}\SpecialCharTok{$}\NormalTok{dens\_poblacion,datos}\SpecialCharTok{$}\NormalTok{fire,summary)}
\end{Highlighting}
\end{Shaded}

Comentario similar a la población. Mayor densidad de población en las
zonas de costa y en las capitales de provincia.

\hypertarget{pendiente}{%
\subsubsection*{pendiente}\label{pendiente}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{pendiente, }\AttributeTok{size=}\NormalTok{ pendiente, }\AttributeTok{alpha=}\NormalTok{pendiente)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de pendiente"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{elevacion}{%
\subsubsection*{elevacion}\label{elevacion}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{elevacion, }\AttributeTok{size=}\NormalTok{ elevacion, }\AttributeTok{alpha=}\NormalTok{elevacion)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de elevacion"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{curvatura}{%
\subsubsection*{curvatura}\label{curvatura}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{curvatura, }\AttributeTok{alpha=}\NormalTok{curvatura)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de curvatura"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{dist_carretera}{%
\subsubsection*{dist\_carretera}\label{dist_carretera}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dist\_carretera, }\AttributeTok{alpha=}\NormalTok{dist\_carretera)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dist\_carretera"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{dist_electr}{%
\subsubsection*{dist\_electr}\label{dist_electr}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dist\_electr, }\AttributeTok{alpha=}\NormalTok{dist\_electr)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dist\_electr"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{dist_camino}{%
\subsubsection*{dist\_camino}\label{dist_camino}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dist\_camino, }\AttributeTok{alpha=}\NormalTok{dist\_camino)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dist\_camino"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{dist_sendero}{%
\subsubsection*{dist\_sendero}\label{dist_sendero}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dist\_sendero, }\AttributeTok{alpha=}\NormalTok{dist\_sendero)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dist\_sendero"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{dist_poblacion}{%
\subsubsection*{dist\_poblacion}\label{dist_poblacion}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dist\_poblacion, }\AttributeTok{alpha=}\NormalTok{dist\_poblacion)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dist\_poblacion"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{dist_ferrocarril}{%
\subsubsection*{dist\_ferrocarril}\label{dist_ferrocarril}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ prov) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{dist\_ferrocarril, }\AttributeTok{alpha=}\NormalTok{dist\_ferrocarril)) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{,}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Distribución espacial de dist\_ferrocarril"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{anuxe1lisis-multivariantes}{%
\subsection{Análisis multivariantes}\label{anuxe1lisis-multivariantes}}

\hypertarget{variables-numuxe9ricas}{%
\subsubsection*{Variables numéricas}\label{variables-numuxe9ricas}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos\_numeric }\OtherTok{=}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select}\NormalTok{(}\FunctionTok{where}\NormalTok{(is.numeric)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{()}

\CommentTok{\# Correlaciones {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{R }\OtherTok{=} \FunctionTok{cor}\NormalTok{(datos\_numeric)}
\FunctionTok{corrplot}\NormalTok{(R,}\AttributeTok{method =} \StringTok{"ellipse"}\NormalTok{,}\AttributeTok{type =} \StringTok{"lower"}\NormalTok{)}
\FunctionTok{summary}\NormalTok{(R}\SpecialCharTok{{-}}\FunctionTok{diag}\NormalTok{(}\FunctionTok{diag}\NormalTok{(R)))}
\CommentTok{\# Las variables más correlacionadas en la muestra son T2M con RH2M (negativamente, {-}0.71), T2M con GWETTOP (negativamente, {-}0.69) y GWETTOP con R2HM (positivamente, 0.68). Tiene sentido que la humedad del aire a dos metros esté correlacionada positivamente con la humedad del suelo y que ambas estén {-}egativamente correlacionadas con la temperatura del aire. También están correladas la población con la densidad de población (positivamente,0.63).}


\CommentTok{\# Gráfico de coordenadas paralelas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(fire,}\FunctionTok{where}\NormalTok{(is.numeric)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggparcoord}\NormalTok{(}\AttributeTok{columns=}\DecValTok{2}\SpecialCharTok{:}\DecValTok{19}\NormalTok{,}\AttributeTok{alphaLines=}\FloatTok{0.1}\NormalTok{,}\AttributeTok{groupColumn =} \StringTok{"fire"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{labels=}\FunctionTok{colnames}\NormalTok{(datos\_numeric)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\# guides(color ="none")+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Tipificación a normal estándar (por defecto)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{9}\NormalTok{),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{90}\NormalTok{))}

\CommentTok{\# Boxplots {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{boxplots }\OtherTok{\textless{}{-}} \FunctionTok{map}\NormalTok{(}\FunctionTok{names}\NormalTok{(datos\_numeric), }\SpecialCharTok{\textasciitilde{}} \FunctionTok{ggplot}\NormalTok{(datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ fire, }\AttributeTok{y =}\NormalTok{ .data[[.x]],}\AttributeTok{fill=}\NormalTok{fire)) }\SpecialCharTok{+}
                  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
                  \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
                  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
                  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \FunctionTok{paste}\NormalTok{(.x, }\StringTok{"\textasciitilde{} fire"}\NormalTok{)))}
\FunctionTok{ggarrange}\NormalTok{(}\AttributeTok{plotlist =}\NormalTok{ boxplots,}\AttributeTok{ncol=}\DecValTok{6}\NormalTok{,}\AttributeTok{nrow=}\DecValTok{3}\NormalTok{)}

\CommentTok{\# PCA {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{pca }\OtherTok{\textless{}{-}} \FunctionTok{princomp}\NormalTok{(datos\_numeric,}\AttributeTok{cor=}\NormalTok{T)}
\FunctionTok{summary}\NormalTok{(pca) }
\CommentTok{\# Se necesitan al menos 11 componentes principales para explicar el 80\% de la variabilidad de las 18 variables numéricas de la muestra (tipificadas) y al menos 14 para explicar el 90\%. Esto refleja, la complejidad del conjunto de datos.}
\end{Highlighting}
\end{Shaded}

\hypertarget{variables-categuxf3ricas}{%
\subsubsection*{Variables categóricas}\label{variables-categuxf3ricas}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datos\_categ }\OtherTok{\textless{}{-}}\NormalTok{ datos }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{select}\NormalTok{(WD10M,orientacion,enp,uso\_suelo) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_drop\_geometry}\NormalTok{()}

\CommentTok{\# Histogramas {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{histogramas }\OtherTok{\textless{}{-}} \FunctionTok{map}\NormalTok{(}\FunctionTok{names}\NormalTok{(datos\_categ), }\SpecialCharTok{\textasciitilde{}} \FunctionTok{ggplot}\NormalTok{(datos, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .data[[.x]], }\AttributeTok{fill =}\NormalTok{ fire)) }\SpecialCharTok{+}
                    \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
                    \FunctionTok{scale\_fill\_hue}\NormalTok{(}\AttributeTok{direction =} \SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
                    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
                    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ .x)}\SpecialCharTok{+}\FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{7}\NormalTok{)))}

\FunctionTok{ggarrange}\NormalTok{(}\AttributeTok{plotlist =}\NormalTok{ histogramas, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{nrow =} \FunctionTok{ceiling}\NormalTok{(}\FunctionTok{length}\NormalTok{(histogramas)}\SpecialCharTok{/}\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{modelos}{%
\section{Modelos}\label{modelos}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Librerías {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan las librerías que se usarán en esta sección}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# Manipulación de datos }
\FunctionTok{library}\NormalTok{(sf) }\CommentTok{\# Vector data}
\FunctionTok{library}\NormalTok{(tidymodels) }\CommentTok{\# Ecosistema para la construcción de modelos}
\FunctionTok{library}\NormalTok{(akima) }\CommentTok{\# Función interp}
\FunctionTok{library}\NormalTok{(magrittr) }\CommentTok{\# Operador \%\textless{}\textgreater{}\% }
\FunctionTok{library}\NormalTok{(ggpubr) }\CommentTok{\# Función ggarrange}
\FunctionTok{library}\NormalTok{(knitr) }\CommentTok{\# Función kable}

\CommentTok{\# Carga de datos {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\FunctionTok{load}\NormalTok{(}\StringTok{"salidas\_intermedias/datos\_strat\_depurados\_geom\_2024{-}05{-}03.RData"}\NormalTok{)}

\CommentTok{\# Agrupación clases uso\_suelo {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Nos quedamos con los 7 niveles del factor más frecuentes (clases 2 y 3)}
\NormalTok{datos }\OtherTok{\textless{}{-}}\NormalTok{ datos }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{uso\_suelo =} \FunctionTok{fct\_lump}\NormalTok{(uso\_suelo,}
                              \AttributeTok{n =} \DecValTok{7}\NormalTok{,}
                              \AttributeTok{other\_level=} \StringTok{"Otro"}\NormalTok{))}

\CommentTok{\# Funciones para la evaluación de modelos {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Función para obtener las medidas de rendimiento de los modelos a partir de un objeto predict }
\NormalTok{get\_metrics }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(pred) \{}
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{res =} \FunctionTok{tibble}\NormalTok{(}
      \AttributeTok{roc\_auc =}\NormalTok{ pred }\SpecialCharTok{|\textgreater{}} \FunctionTok{roc\_auc}\NormalTok{(}\AttributeTok{truth =}\NormalTok{ fire, .pred\_0) }\SpecialCharTok{|\textgreater{}} \FunctionTok{pull}\NormalTok{(.estimate),}
      \AttributeTok{accuracy =}\NormalTok{ pred }\SpecialCharTok{|\textgreater{}} \FunctionTok{accuracy}\NormalTok{(}\AttributeTok{truth =}\NormalTok{ fire, .pred\_class) }\SpecialCharTok{|\textgreater{}} \FunctionTok{pull}\NormalTok{(.estimate),}
      \AttributeTok{recall =}\NormalTok{ pred }\SpecialCharTok{|\textgreater{}} \FunctionTok{sensitivity}\NormalTok{(}\AttributeTok{truth =}\NormalTok{ fire, .pred\_class,}\AttributeTok{event\_level=}\StringTok{"second"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} \FunctionTok{pull}\NormalTok{(.estimate),}
      \AttributeTok{specificity =}\NormalTok{ pred }\SpecialCharTok{|\textgreater{}} \FunctionTok{spec}\NormalTok{(}\AttributeTok{truth =}\NormalTok{ fire, .pred\_class,}\AttributeTok{event\_level=}\StringTok{"second"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} \FunctionTok{pull}\NormalTok{(.estimate),}
      \AttributeTok{precision =}\NormalTok{ pred }\SpecialCharTok{|\textgreater{}} \FunctionTok{precision}\NormalTok{(}\AttributeTok{truth =}\NormalTok{ fire, .pred\_class,}\AttributeTok{event\_level=}\StringTok{"second"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} \FunctionTok{pull}\NormalTok{(.estimate)),}
    \AttributeTok{conf\_mat =}\NormalTok{ pred }\SpecialCharTok{|\textgreater{}} \FunctionTok{conf\_mat}\NormalTok{(}\AttributeTok{truth =}\NormalTok{ fire, .pred\_class))}
\NormalTok{\}}

\CommentTok{\# Función para mostrar gráficamente los resultados del tuning de un modelo con dos parámetros }
\NormalTok{tuning\_plot }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(mod\_res) \{}
\NormalTok{  datos\_metrics }\OtherTok{=}\NormalTok{ mod\_res }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{collect\_metrics}\NormalTok{()}

\NormalTok{  plots }\OtherTok{=} \FunctionTok{list}\NormalTok{()}
  
  \ControlFlowTok{for}\NormalTok{ (metric }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(datos\_metrics}\SpecialCharTok{$}\NormalTok{.metric)) \{}
    
\NormalTok{    datos }\OtherTok{=}\NormalTok{ datos\_metrics }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{filter}\NormalTok{(.metric}\SpecialCharTok{==}\NormalTok{metric) }
    
    \CommentTok{\# Interpolar los datos faltantes}
\NormalTok{    datos\_interp }\OtherTok{\textless{}{-}} \FunctionTok{interp}\NormalTok{(datos[[}\DecValTok{1}\NormalTok{]], datos[[}\DecValTok{2}\NormalTok{]], datos}\SpecialCharTok{$}\NormalTok{mean)}
    
    \CommentTok{\# Crear un nuevo dataframe con los datos interpolados}
\NormalTok{    datos\_interp\_df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
      \FunctionTok{expand.grid}\NormalTok{(}\AttributeTok{x =}\NormalTok{ datos\_interp}\SpecialCharTok{$}\NormalTok{x, }\AttributeTok{y =}\NormalTok{ datos\_interp}\SpecialCharTok{$}\NormalTok{y), }\AttributeTok{z =} \FunctionTok{as.vector}\NormalTok{(datos\_interp}\SpecialCharTok{$}\NormalTok{z))}
    
    \CommentTok{\# Crear el gráfico de mapa de calor con interpolación}
\NormalTok{    p }\OtherTok{=} \FunctionTok{ggplot}\NormalTok{(datos\_interp\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{fill =}\NormalTok{ z)) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{(}\AttributeTok{option =} \StringTok{"turbo"}\NormalTok{, }\AttributeTok{name =} \ConstantTok{NULL}\NormalTok{,}\AttributeTok{na.value =} \StringTok{"transparent"}\NormalTok{)}\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{""}\NormalTok{,}
           \AttributeTok{x =} \FunctionTok{colnames}\NormalTok{(datos)[}\DecValTok{1}\NormalTok{],}
           \AttributeTok{y =} \FunctionTok{colnames}\NormalTok{(datos)[}\DecValTok{2}\NormalTok{],}
           \AttributeTok{fill =}\NormalTok{ metric) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{()}
    
\NormalTok{    plots[[metric]] }\OtherTok{=}\NormalTok{ p}
\NormalTok{  \}}
  \FunctionTok{ggarrange}\NormalTok{(}\AttributeTok{plotlist =}\NormalTok{ plots,}
            \AttributeTok{labels=}\FunctionTok{c}\NormalTok{(}\StringTok{"Accuracy"}\NormalTok{,}\StringTok{"Specificy"}\NormalTok{,}\StringTok{"ROC{-}AUC"}\NormalTok{,}\StringTok{"Recall"}\NormalTok{),}
            \AttributeTok{align =} \StringTok{"hv"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{particiuxf3n-temporal-entrenamiento-validaciuxf3n-test}{%
\subsection{Partición temporal entrenamiento / validación /
test}\label{particiuxf3n-temporal-entrenamiento-validaciuxf3n-test}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}

\NormalTok{splits }\OtherTok{=} \FunctionTok{initial\_validation\_time\_split}\NormalTok{(datos, }
                                       \AttributeTok{prop=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{,}\FloatTok{0.2}\NormalTok{))}

\NormalTok{training }\OtherTok{\textless{}{-}} \FunctionTok{training}\NormalTok{(splits) }\SpecialCharTok{\%\textgreater{}\%}  \FunctionTok{st\_drop\_geometry}\NormalTok{()}
\NormalTok{val\_set }\OtherTok{\textless{}{-}} \FunctionTok{validation\_set}\NormalTok{(splits) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_drop\_geometry}\NormalTok{()}
\NormalTok{test  }\OtherTok{\textless{}{-}} \FunctionTok{testing}\NormalTok{(splits) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_drop\_geometry}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{regresiuxf3n-loguxedstica-con-penalizaciuxf3n}{%
\subsection{Regresión logística con
penalización}\label{regresiuxf3n-loguxedstica-con-penalizaciuxf3n}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1º Definimos el modelo:}
\NormalTok{lr\_mod }\OtherTok{\textless{}{-}} 
  \FunctionTok{logistic\_reg}\NormalTok{(}\AttributeTok{penalty =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{mixture =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"glmnet"}\NormalTok{)}

\CommentTok{\# 2º Creamos la receta}
\NormalTok{lr\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{,}\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# step\_holiday(date, holidays = holidays) \%\textgreater{}\% }
  \FunctionTok{step\_rm}\NormalTok{(date,cod\_municipio,municipio) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se eliminan variables identificadoras}
  \FunctionTok{step\_dummy}\NormalTok{(}\FunctionTok{all\_nominal\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se crean variables dummy para los factores}
  \FunctionTok{step\_lincomb}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variablies con dependencia lineal exacta}
  \FunctionTok{step\_corr}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variables con correlación superior a 0.9}
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Eliminar variables con varianza nula}
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\CommentTok{\# Se normalizan todos los predictores}

\CommentTok{\# 3º Creamos el workflow}
\NormalTok{lr\_workflow }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(lr\_mod) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(lr\_recipe)}

\CommentTok{\# 4º Creamos el grid para los parámetros}
\NormalTok{lr\_reg\_grid }\OtherTok{\textless{}{-}} \FunctionTok{expand\_grid}\NormalTok{(}\AttributeTok{penalty =} \DecValTok{10}\SpecialCharTok{\^{}}\FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{10}\NormalTok{),}
                           \AttributeTok{mixture =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\AttributeTok{length.out=}\DecValTok{10}\NormalTok{))}

\CommentTok{\# 5º Ajustamos el modelo}
\NormalTok{lr\_res }\OtherTok{\textless{}{-}} 
\NormalTok{  lr\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =}\NormalTok{ lr\_reg\_grid,}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# 6º Evaluación de modelos}
\FunctionTok{tuning\_plot}\NormalTok{(lr\_res)}

\NormalTok{lr\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))   }


\CommentTok{\# 7º Selección del mejor modelo}
\NormalTok{lr\_best }\OtherTok{\textless{}{-}} 
\NormalTok{  lr\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric=}\StringTok{"accuracy"}\NormalTok{)}
\NormalTok{lr\_best}

\CommentTok{\# Extraer coeficientes}
\NormalTok{lr\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{finalize\_workflow}\NormalTok{(lr\_best) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{fit}\NormalTok{(training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_fit\_parsnip}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{tidy}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{print}\NormalTok{(}\AttributeTok{n=}\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{regresiuxf3n-loguxedstica-con-penalizaciuxf3n-pca}{%
\subsection{Regresión logística con penalización +
PCA}\label{regresiuxf3n-loguxedstica-con-penalizaciuxf3n-pca}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1º Creamos el modelo}
\NormalTok{lr\_pca\_mod }\OtherTok{\textless{}{-}} 
  \FunctionTok{logistic\_reg}\NormalTok{(}\AttributeTok{penalty =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{mixture =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"glmnet"}\NormalTok{)}


\CommentTok{\# 2º Creamos la receta}
\NormalTok{lr\_pca\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{,}\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# step\_holiday(date, holidays = holidays) \%\textgreater{}\% }
  \FunctionTok{step\_rm}\NormalTok{(date,cod\_municipio,municipio) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se eliminan variables identificadoras}
  \FunctionTok{step\_dummy}\NormalTok{(}\FunctionTok{all\_nominal\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se crean variables dummy para los factores}
  \FunctionTok{step\_lincomb}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variablies con dependencia lineal exacta}
  \FunctionTok{step\_corr}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variables con correlación superior a 0.9}
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Eliminar variables con varianza nula}
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se normalizan todos los predictores}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{all\_numeric\_predictors}\NormalTok{(),}\AttributeTok{num\_comp =} \FunctionTok{tune}\NormalTok{())}

\CommentTok{\# 3º Creamos el workflow}
\NormalTok{lr\_pca\_workflow }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(lr\_pca\_mod) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(lr\_pca\_recipe)}

\CommentTok{\# 4º Creamos el grid para los parámetros}
\NormalTok{lr\_pca\_reg\_grid }\OtherTok{\textless{}{-}} \FunctionTok{expand\_grid}\NormalTok{(}\AttributeTok{penalty =} \DecValTok{10}\SpecialCharTok{\^{}}\FunctionTok{seq}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{10}\NormalTok{),}
                               \AttributeTok{mixture =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\AttributeTok{length.out=}\DecValTok{10}\NormalTok{),}
                               \AttributeTok{num\_comp =} \FunctionTok{c}\NormalTok{(}\DecValTok{20}\NormalTok{,}\DecValTok{25}\NormalTok{,}\DecValTok{30}\NormalTok{,}\DecValTok{35}\NormalTok{,}\DecValTok{40}\NormalTok{,}\DecValTok{45}\NormalTok{,}\DecValTok{50}\NormalTok{))}

\CommentTok{\# 5º Ajustamos el modelo}
\NormalTok{lr\_pca\_res }\OtherTok{\textless{}{-}} 
\NormalTok{  lr\_pca\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =}\NormalTok{ lr\_pca\_reg\_grid,}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# 6º Evalación modelos}
\NormalTok{lr\_pca\_tuning }\OtherTok{=}\NormalTok{ lr\_pca\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\CommentTok{\# 7º Selección del mejor modelo}
\NormalTok{lr\_pca\_best }\OtherTok{\textless{}{-}} 
\NormalTok{  lr\_pca\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric=}\StringTok{"accuracy"}\NormalTok{)}
\NormalTok{lr\_pca\_best}
\end{Highlighting}
\end{Shaded}

\hypertarget{uxe1rboles-de-decisuxf3n}{%
\subsection{Árboles de decisón}\label{uxe1rboles-de-decisuxf3n}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1º Creamos el modelo}
\NormalTok{dt\_mod }\OtherTok{\textless{}{-}} 
  \FunctionTok{decision\_tree}\NormalTok{(}\AttributeTok{cost\_complexity =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"rpart"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)  }

\CommentTok{\# 2º Creamos la receta}
\NormalTok{dt\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{, }\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# step\_holiday(date) \%\textgreater{}\% }
  \FunctionTok{step\_rm}\NormalTok{(date, cod\_municipio, municipio) }

\CommentTok{\# 3º Creamos el workflow}
\NormalTok{dt\_workflow }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(dt\_mod) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(dt\_recipe)}

\CommentTok{\# 4º Se ajusta el modelo }
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\NormalTok{dt\_res }\OtherTok{\textless{}{-}} 
\NormalTok{  dt\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =} \DecValTok{10}\NormalTok{,}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# 5º Se evalúan los modelos obtenidos}
\NormalTok{dt\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\CommentTok{\# Gráfico del ajuste}
\NormalTok{  dt\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cost\_complexity, }\AttributeTok{y =}\NormalTok{ mean,}\AttributeTok{col=}\NormalTok{.metric)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_log10}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_number}\NormalTok{())}\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\CommentTok{\# 6º Selección del mejor modelo  }
\NormalTok{dt\_best }\OtherTok{\textless{}{-}}\NormalTok{ dt\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric =} \StringTok{"accuracy"}\NormalTok{)}
\NormalTok{dt\_best}
\end{Highlighting}
\end{Shaded}

\hypertarget{bosques-aleatorios}{%
\subsection{Bosques aleatorios}\label{bosques-aleatorios}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Detectar el número de núcleos para trabajar en paralelo}
\NormalTok{cores }\OtherTok{\textless{}{-}}\NormalTok{ parallel}\SpecialCharTok{::}\FunctionTok{detectCores}\NormalTok{()}
\NormalTok{cores}

\CommentTok{\# Construimos el modelo, especificando el número de núcleos a usar en la computación en paralelo de forma que la computación sea más eficiente}

\CommentTok{\# ETAPA 1: fijado mtry=4, se ajusta min\_n}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# 1º Construir el modelo}
\NormalTok{rf\_mod1 }\OtherTok{\textless{}{-}} 
  \FunctionTok{rand\_forest}\NormalTok{(}\AttributeTok{mtry =} \DecValTok{4}\NormalTok{, }\AttributeTok{min\_n =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{trees =} \DecValTok{1000}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"ranger"}\NormalTok{, }\AttributeTok{num.threads =}\NormalTok{ cores) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)}

\CommentTok{\# 2º Construir la receta con el preprocesamiento}
\NormalTok{rf\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{, }\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# step\_holiday(date) \%\textgreater{}\% }
  \FunctionTok{step\_rm}\NormalTok{(date, cod\_municipio, municipio) }
\CommentTok{\# No normalizamos en este caso pues no es necesario}

\CommentTok{\# 3º Ensamblar todo con workflow}
\NormalTok{rf\_workflow1 }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(rf\_mod1) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(rf\_recipe)}

\CommentTok{\# 4º Train and tune}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}

\NormalTok{rf\_res1 }\OtherTok{\textless{}{-}}
\NormalTok{  rf\_workflow }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =} \FunctionTok{expand\_grid}\NormalTok{(}\AttributeTok{min\_n =} \FunctionTok{seq}\NormalTok{(}\DecValTok{1000}\NormalTok{,}\DecValTok{2500}\NormalTok{,}\DecValTok{100}\NormalTok{)),}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# Resultados del tuning}

\NormalTok{rf\_tuning1 }\OtherTok{\textless{}{-}}\NormalTok{ rf\_res1 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\NormalTok{rf\_tuning1}

\CommentTok{\# plot}

\NormalTok{rf\_plot1 }\OtherTok{\textless{}{-}} 
\NormalTok{  rf\_res1 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ min\_n, }\AttributeTok{y =}\NormalTok{ mean,}\AttributeTok{col=}\NormalTok{.metric)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Etapa 1}\SpecialCharTok{\textbackslash{}n}\StringTok{Fijado mtry = 4, se ajusta min\_n"}\NormalTok{)}


\CommentTok{\# Mejor modelo}
\NormalTok{rf\_best1 }\OtherTok{\textless{}{-}} 
\NormalTok{  rf\_res1 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric =} \StringTok{"spec"}\NormalTok{)}

\NormalTok{rf\_best1}

\NormalTok{rf\_metrics1 }\OtherTok{\textless{}{-}}\NormalTok{ rf\_res1 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_predictions}\NormalTok{(}\AttributeTok{parameters =}\NormalTok{ rf\_best1) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{get\_metrics}\NormalTok{()}

\NormalTok{rf\_metrics1}


\CommentTok{\# ETAPA 2: fijado min\_n de la etapa anterior, se ajusta mtry}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# 1º Se construye el modelo}
\NormalTok{rf\_mod2 }\OtherTok{\textless{}{-}} 
  \FunctionTok{rand\_forest}\NormalTok{(}\AttributeTok{mtry =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{min\_n =}\NormalTok{ rf\_best1}\SpecialCharTok{$}\NormalTok{min\_n, }\AttributeTok{trees =} \DecValTok{1000}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"ranger"}\NormalTok{, }\AttributeTok{num.threads =}\NormalTok{ cores) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)}

\CommentTok{\# 2º Se usa la misma receta que antes}

\CommentTok{\# 3º Ensamblar todo con workflow}
\NormalTok{rf\_workflow2 }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(rf\_mod2) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(rf\_recipe)}

\CommentTok{\# 4º Train and tune}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}

\NormalTok{rf\_res2 }\OtherTok{\textless{}{-}}
\NormalTok{  rf\_workflow2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =} \FunctionTok{expand\_grid}\NormalTok{(}\AttributeTok{mtry =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{),}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}


\CommentTok{\# Resultados del tuning}

\NormalTok{rf\_tuning2 }\OtherTok{\textless{}{-}}\NormalTok{ rf\_res2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\NormalTok{rf\_tuning2}

\CommentTok{\#plot}
\NormalTok{rf\_plot2 }\OtherTok{\textless{}{-}} 
\NormalTok{  rf\_res2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mtry, }\AttributeTok{y =}\NormalTok{ mean,}\AttributeTok{col=}\NormalTok{.metric)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Etapa 2}\SpecialCharTok{\textbackslash{}n}\StringTok{Fijado min\_n = "}\NormalTok{, rf\_best1}\SpecialCharTok{$}\NormalTok{min\_n, }\StringTok{" se ajusta mtry"}\NormalTok{))}

\CommentTok{\# Mejor modelo}
\NormalTok{rf\_best2 }\OtherTok{\textless{}{-}} 
\NormalTok{  rf\_res2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric =} \StringTok{"spec"}\NormalTok{)}
\NormalTok{rf\_best2}

\NormalTok{rf\_metrics2 }\OtherTok{\textless{}{-}}\NormalTok{ rf\_res2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_predictions}\NormalTok{(}\AttributeTok{parameters =}\NormalTok{ rf\_best2) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{get\_metrics}\NormalTok{()}

\NormalTok{rf\_metrics2}


\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# Plots}
\FunctionTok{ggarrange}\NormalTok{(rf\_plot1,rf\_plot2,}\AttributeTok{nrow=}\DecValTok{1}\NormalTok{,}\AttributeTok{common.legend =}\NormalTok{ T,}\AttributeTok{legend =} \StringTok{"bottom"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{k-nearest-neighbours}{%
\subsection{k-Nearest Neighbours}\label{k-nearest-neighbours}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1º Definimos el modelo:}
\NormalTok{knn\_mod }\OtherTok{\textless{}{-}} 
  \FunctionTok{nearest\_neighbor}\NormalTok{(}\AttributeTok{neighbors =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"kknn"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)  }

\CommentTok{\# 2º Creamos la receta}
\NormalTok{knn\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{,}\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# step\_holiday(date, holidays = holidays) \%\textgreater{}\% }
  \FunctionTok{step\_rm}\NormalTok{(date,cod\_municipio,municipio) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se eliminan variables identificadoras}
  \FunctionTok{step\_dummy}\NormalTok{(}\FunctionTok{all\_nominal\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Se crean variables dummy para los factores}
  \FunctionTok{step\_lincomb}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variablies con dependencia lineal exacta}
  \FunctionTok{step\_corr}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variables con correlación superior a 0.9}
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Eliminar variables con varianza nula}
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\CommentTok{\# Se normalizan todos los predictores}

\CommentTok{\# 3º Creamos el workflow}
\NormalTok{knn\_workflow }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(knn\_mod) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(knn\_recipe)}

\CommentTok{\# 4º Train and tune}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\NormalTok{knn\_res }\OtherTok{\textless{}{-}} 
\NormalTok{  knn\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# fit(training)}
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =} \FunctionTok{expand\_grid}\NormalTok{(}\AttributeTok{neighbors =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{25}\NormalTok{,}\FunctionTok{seq}\NormalTok{(}\DecValTok{25}\NormalTok{,}\DecValTok{400}\NormalTok{,}\DecValTok{25}\NormalTok{))),}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# 5º Evaluació de los modelos}
\NormalTok{knn\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\NormalTok{knn\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# filter(.metric == "accuracy") \%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ neighbors, }\AttributeTok{y =}\NormalTok{ mean,}\AttributeTok{col=}\NormalTok{.metric)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}

\CommentTok{\# 6º Selección del mejor modelo}
\NormalTok{knn\_best }\OtherTok{\textless{}{-}}\NormalTok{ knn\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric =} \StringTok{"accuracy"}\NormalTok{)}
\NormalTok{knn\_best}
\end{Highlighting}
\end{Shaded}

\hypertarget{svm-lineal}{%
\subsection{SVM lineal}\label{svm-lineal}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1º Construir el modelo}
\NormalTok{svm\_mod }\OtherTok{\textless{}{-}} 
  \FunctionTok{svm\_linear}\NormalTok{(}\AttributeTok{cost =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"kernlab"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)}

\CommentTok{\# 2º Construir la receta con el preprocesamiento}
\NormalTok{svm\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{, }\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_rm}\NormalTok{(date, cod\_municipio, municipio) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_dummy}\NormalTok{(}\FunctionTok{all\_nominal\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{())}

\CommentTok{\# 3º Ensamblar todo con workflow}
\NormalTok{svm\_workflow }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(svm\_mod) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(svm\_recipe)}

\CommentTok{\# 4º Train and tune}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\NormalTok{svm\_res }\OtherTok{\textless{}{-}} 
\NormalTok{  svm\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =} \DecValTok{15}\NormalTok{,}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# 5º Evaluación de resultados del tuning}
\NormalTok{svm\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\NormalTok{svm\_plot }\OtherTok{\textless{}{-}} 
\NormalTok{  svm\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{.metric =} \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"recall"}\NormalTok{,}\StringTok{"spec"}\NormalTok{,}
                          \FunctionTok{ifelse}\NormalTok{(.metric }\SpecialCharTok{==} \StringTok{"spec"}\NormalTok{,}\StringTok{"recall"}\NormalTok{,}
\NormalTok{                                 .metric))) }\SpecialCharTok{\%\textgreater{}\%} 
  \CommentTok{\# filter(.metric == "accuracy") \%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cost, }\AttributeTok{y =}\NormalTok{ mean,}\AttributeTok{col=}\NormalTok{.metric)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\NormalTok{svm\_plot}

\CommentTok{\# 6º Selección del mejor modelo}
\NormalTok{svm\_best }\OtherTok{\textless{}{-}} 
\NormalTok{  svm\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric=}\StringTok{"accuracy"}\NormalTok{)}
\NormalTok{svm\_best}
\end{Highlighting}
\end{Shaded}

\hypertarget{svm-radial}{%
\subsection{SVM radial}\label{svm-radial}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1º Construir el modelo}
\NormalTok{svm\_rbf\_mod }\OtherTok{\textless{}{-}} 
  \FunctionTok{svm\_rbf}\NormalTok{(}\AttributeTok{cost =} \FunctionTok{tune}\NormalTok{(),}\AttributeTok{rbf\_sigma =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"kernlab"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)}

\CommentTok{\# 2º Construir la receta con el preprocesamiento}
\NormalTok{svm\_rbf\_recipe }\OtherTok{\textless{}{-}} 
  \FunctionTok{recipe}\NormalTok{(fire }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ training) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_date}\NormalTok{(date,}\AttributeTok{features =} \FunctionTok{c}\NormalTok{(}\StringTok{"dow"}\NormalTok{, }\StringTok{"month"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_rm}\NormalTok{(date, cod\_municipio, municipio) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_dummy}\NormalTok{(}\FunctionTok{all\_nominal\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_lincomb}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variablies con dependencia lineal exacta}
  \FunctionTok{step\_corr}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Elimina variables con correlación superior a 0.9}
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{())}

\CommentTok{\# 3º Ensamblar todo con workflow}
\NormalTok{svm\_rbf\_workflow }\OtherTok{\textless{}{-}} 
  \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_model}\NormalTok{(svm\_rbf\_mod) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_recipe}\NormalTok{(svm\_rbf\_recipe)}

\CommentTok{\# 4º Train and tune}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\NormalTok{svm\_rbf\_res }\OtherTok{\textless{}{-}} 
\NormalTok{  svm\_rbf\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{tune\_grid}\NormalTok{(val\_set,}
            \AttributeTok{grid =} \DecValTok{8}\NormalTok{,}
            \AttributeTok{control =} \FunctionTok{control\_grid}\NormalTok{(}\AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{),}
            \AttributeTok{metrics =} \FunctionTok{metric\_set}\NormalTok{(accuracy,roc\_auc,recall,spec))}

\CommentTok{\# 5º Evaluación de resultados del tuning}
\NormalTok{svm\_rbf\_res }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{collect\_metrics}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(.metric)}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{max =} \FunctionTok{max}\NormalTok{(mean),}\AttributeTok{min=}\FunctionTok{min}\NormalTok{(mean))}

\CommentTok{\# 6º Selección del mejor modelo}
\NormalTok{svm\_rbf\_best }\OtherTok{\textless{}{-}} 
\NormalTok{  svm\_rbf\_res }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric=}\StringTok{"accuracy"}\NormalTok{)}

\NormalTok{svm\_rbf\_best}
\end{Highlighting}
\end{Shaded}

\hypertarget{comparaciuxf3n}{%
\subsection{Comparación}\label{comparaciuxf3n}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{models }\OtherTok{=} \FunctionTok{tibble}\NormalTok{(}\AttributeTok{model\_name =} \FunctionTok{c}\NormalTok{(}\StringTok{"lr"}\NormalTok{,}\StringTok{"lr\_pca"}\NormalTok{,}\StringTok{"dt"}\NormalTok{,}\StringTok{"rf"}\NormalTok{,}\StringTok{"svm\_linear"}\NormalTok{,}\StringTok{"svm\_rbf"}\NormalTok{,}\StringTok{"knn"}\NormalTok{),}
                \AttributeTok{models\_tune =} \FunctionTok{list}\NormalTok{(lr\_res,lr\_pca\_res,dt\_res,rf\_res2,svm\_res,svm\_rbf\_res,knn\_res),}
                \AttributeTok{models\_workflow =} \FunctionTok{list}\NormalTok{(lr\_workflow,lr\_pca\_workflow,dt\_workflow,rf\_workflow2,svm\_workflow,svm\_rbf\_workflow,knn\_workflow))}

\CommentTok{\# save(models, file="salidas\_intermedias/all\_models.RData")}

\FunctionTok{load}\NormalTok{(}\StringTok{"salidas\_intermedias/all\_models.RData"}\NormalTok{)}
\NormalTok{models }\OtherTok{=}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{best\_tuning =} \FunctionTok{map}\NormalTok{(models\_tune,}\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{select\_best}\NormalTok{(x,}\AttributeTok{metric =} \StringTok{"accuracy"}\NormalTok{)),}
         \AttributeTok{best\_metrics =} \FunctionTok{map2}\NormalTok{(models\_tune,}
\NormalTok{                             best\_tuning,                                               }\SpecialCharTok{\textasciitilde{}} \FunctionTok{collect\_predictions}\NormalTok{(.x,}\AttributeTok{parameters =}\NormalTok{ .y) }\SpecialCharTok{\%\textgreater{}\%}                                                  \FunctionTok{get\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}                                                  \FunctionTok{extract2}\NormalTok{(}\DecValTok{1}\NormalTok{)), }\CommentTok{\# Para extraer solo las medidas y no la matriz de confusión}
         \AttributeTok{roc =} \FunctionTok{map2}\NormalTok{(models\_tune,}
\NormalTok{                    best\_tuning,}
                    \SpecialCharTok{\textasciitilde{}} \FunctionTok{collect\_predictions}\NormalTok{(.x,}\AttributeTok{parameters =}\NormalTok{ .y) }\SpecialCharTok{\%\textgreater{}\%}                                         \FunctionTok{roc\_curve}\NormalTok{(fire, .pred\_0))}
\NormalTok{) }

\CommentTok{\# metricas}
\NormalTok{metrics }\OtherTok{=}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select}\NormalTok{(model\_name,best\_metrics) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{unnest}\NormalTok{(best\_metrics)}
\FunctionTok{kable}\NormalTok{(metrics,}\AttributeTok{digits=}\DecValTok{3}\NormalTok{) }

\CommentTok{\# curva roc}
\NormalTok{metrics }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(roc\_auc, accuracy, recall, specificity, precision),}
               \AttributeTok{names\_to =} \StringTok{"metric"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ metric, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{group =}\NormalTok{ model\_name)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{col =}\NormalTok{ model\_name),}\AttributeTok{size=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{col =}\NormalTok{ model\_name),}\AttributeTok{size=}\FloatTok{2.3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_viridis\_d}\NormalTok{(}\AttributeTok{option=}\StringTok{"turbo"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{linetype=}\StringTok{"dotted"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{col =} \StringTok{"Modelo"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Métricas sobre validación"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.line.x =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{),}
        \AttributeTok{axis.line.y =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{))}
  
\CommentTok{\# plot medidas}
\NormalTok{models }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{select}\NormalTok{(model\_name,roc) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{unnest}\NormalTok{(roc) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ specificity, }\AttributeTok{y =}\NormalTok{ sensitivity, }\AttributeTok{col =}\NormalTok{ model\_name)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{(}\AttributeTok{lwd =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_abline}\NormalTok{(}\AttributeTok{lty =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_viridis\_d}\NormalTok{(}\AttributeTok{option=}\StringTok{"turbo"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Modelo"}\NormalTok{)}\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_viridis\_d(option = "turbo",name="Modelo") +}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.line.x =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{),}
        \AttributeTok{axis.line.y =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Curva ROC en validación"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{test}{%
\subsection{Test}\label{test}}

Se unen los conjuntos training y validation para entrenar el modelo
final

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\NormalTok{models }\OtherTok{\textless{}{-}}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{final\_workflow =} \FunctionTok{map2}\NormalTok{(models\_workflow, best\_tuning,finalize\_workflow),}
         \AttributeTok{last\_fit =} \FunctionTok{map}\NormalTok{(final\_workflow, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{last\_fit}\NormalTok{(x,splits,}\AttributeTok{add\_validation\_set=}\NormalTok{T)))}

\NormalTok{models }\OtherTok{=}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{test\_metrics =} \FunctionTok{map}\NormalTok{(last\_fit,      }
                            \SpecialCharTok{\textasciitilde{}}\FunctionTok{collect\_predictions}\NormalTok{(.x) }\SpecialCharTok{\%\textgreater{}\%}                                                  \FunctionTok{get\_metrics}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  
                              \FunctionTok{extract2}\NormalTok{(}\DecValTok{1}\NormalTok{)), }\CommentTok{\# Para extraer solo las medidas}
         \AttributeTok{test\_roc =} \FunctionTok{map}\NormalTok{(last\_fit,}
                        \SpecialCharTok{\textasciitilde{}}\FunctionTok{collect\_predictions}\NormalTok{(.x) }\SpecialCharTok{\%\textgreater{}\%}                                              \FunctionTok{roc\_curve}\NormalTok{(fire, .pred\_0))                           ) }

\CommentTok{\# save(models, file="salidas\_intermedias/all\_models\_test.RData")}

\CommentTok{\# metricas en test}
\NormalTok{test\_metrics }\OtherTok{=}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{select}\NormalTok{(model\_name,test\_metrics) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{unnest}\NormalTok{(test\_metrics)}
\FunctionTok{kable}\NormalTok{(test\_metrics,}\AttributeTok{digits=}\DecValTok{3}\NormalTok{)}

\CommentTok{\# plot}
\NormalTok{test\_metrics }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(roc\_auc, accuracy, recall, specificity, precision),}
               \AttributeTok{names\_to =} \StringTok{"metric"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ metric, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{group =}\NormalTok{ model\_name)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{col =}\NormalTok{ model\_name),}\AttributeTok{size=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{col =}\NormalTok{ model\_name),}\AttributeTok{size=}\FloatTok{2.3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_viridis\_d}\NormalTok{(}\AttributeTok{option=}\StringTok{"turbo"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\AttributeTok{linetype=}\StringTok{"dotted"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{col =} \StringTok{"Modelo"}\NormalTok{, }\AttributeTok{title =} \StringTok{"Métricas sobre test"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.line.x =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{),}
        \AttributeTok{axis.line.y =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{))}
  
\CommentTok{\# roc}
\NormalTok{models }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{select}\NormalTok{(model\_name,test\_roc) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{unnest}\NormalTok{(test\_roc) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ specificity, }\AttributeTok{y =}\NormalTok{ sensitivity, }\AttributeTok{col =}\NormalTok{ model\_name)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{(}\AttributeTok{lwd =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_abline}\NormalTok{(}\AttributeTok{lty =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{coord\_equal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_viridis\_d}\NormalTok{(}\AttributeTok{option=}\StringTok{"turbo"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Modelo"}\NormalTok{)}\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_viridis\_d(option = "turbo",name="Modelo") +}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.line.x =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{),}
        \AttributeTok{axis.line.y =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Curva ROC en test"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Para calcular la medida de importancia de las variables en bosque
aleatorio. No se hace desde el principio para que la computación sea más
rápida.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Se hace el last\_fit manualmente:}
\NormalTok{cores }\OtherTok{=} \DecValTok{8}

\CommentTok{\# last model}
\NormalTok{last\_rf\_mod }\OtherTok{\textless{}{-}} \FunctionTok{rand\_forest}\NormalTok{(}\AttributeTok{mtry =}\NormalTok{ rf\_best2}\SpecialCharTok{$}\NormalTok{mtry, }\AttributeTok{min\_n =}\NormalTok{ rf\_best1}\SpecialCharTok{$}\NormalTok{min\_n, }\AttributeTok{trees =} \DecValTok{1000}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"ranger"}\NormalTok{, }\AttributeTok{num.threads =}\NormalTok{ cores,}\AttributeTok{importance=}\StringTok{"impurity"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{)}
  
\CommentTok{\# last workflow}
\NormalTok{last\_rf\_workflow }\OtherTok{\textless{}{-}} 
\NormalTok{  rf\_workflow2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{update\_model}\NormalTok{(last\_rf\_mod)}

\CommentTok{\# last fit}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{345}\NormalTok{)}
\NormalTok{last\_rf\_fit }\OtherTok{\textless{}{-}} 
\NormalTok{  last\_rf\_workflow }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{last\_fit}\NormalTok{(splits,}
           \AttributeTok{add\_validation\_set =}\NormalTok{ T)}
\CommentTok{\# VIP}
\NormalTok{last\_rf\_fit }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_fit\_parsnip}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{vip}\NormalTok{(}\AttributeTok{num\_features =} \DecValTok{50}\NormalTok{,}\AttributeTok{aesthetics =} \FunctionTok{list}\NormalTok{(}\AttributeTok{fill=}\StringTok{"lightblue"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{aplicaciuxf3n-de-los-modelos}{%
\section{Aplicación de los modelos}\label{aplicaciuxf3n-de-los-modelos}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Librerías {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Se cargan las librerías que se usarán en esta sección}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# Manipulación de datos }
\FunctionTok{library}\NormalTok{(sf) }\CommentTok{\# Vector data}
\FunctionTok{library}\NormalTok{(tidymodels) }\CommentTok{\# Ecosistema para la construcción de modelos}
\FunctionTok{library}\NormalTok{(ggpubr) }\CommentTok{\# Función ggarrange}
\FunctionTok{library}\NormalTok{(knitr) }\CommentTok{\# Función kable}
\FunctionTok{library}\NormalTok{(skimr) }\CommentTok{\# Función skim}
\FunctionTok{library}\NormalTok{(terra)}

\CommentTok{\# Carga de datos {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\FunctionTok{load}\NormalTok{(}\StringTok{"salidas\_intermedias/datos\_strat\_depurados\_geom\_2024{-}04{-}27.RData"}\NormalTok{) }

\CommentTok{\# Polígono de Andalucía {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{and }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_ccaa}\NormalTok{(}\AttributeTok{ccaa =} \StringTok{"Andalucía"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos))}
\end{Highlighting}
\end{Shaded}

\hypertarget{visiuxf3n-general-del-desempeuxf1o-del-modelo}{%
\subsection{Visión general del desempeño del
modelo}\label{visiuxf3n-general-del-desempeuxf1o-del-modelo}}

Se construye una rejilla de puntos con una separación de 10km entre
ellos (en la dirección Norte-Sur y Este-Oeste). En cada uno de los
puntos se predice la probabilidad de incendio el día 15 de cada mes
usando los mejores modelos construidos. Para ello, primero hay que
asignar a cada punto los valores correspondientes de las variables
predictoras consideradas.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# grid de puntos 10km x 10km de andalucía}
\NormalTok{grid }\OtherTok{=} \FunctionTok{st\_make\_grid}\NormalTok{(and,}
                    \AttributeTok{cellsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{10000}\NormalTok{,}\DecValTok{10000}\NormalTok{), }\CommentTok{\# 10000}
                    \AttributeTok{what =} \StringTok{"centers"}\NormalTok{)[and]}
\NormalTok{g }\OtherTok{=}\NormalTok{ and }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
 
\NormalTok{g }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ grid,}\AttributeTok{color=}\StringTok{"red"}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Malla de puntos con una resulción de 10km x 10km"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Se va a analizar cada observación el 15 de cada mes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sample }\OtherTok{=} \ConstantTok{NULL}

\ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(sample))\{}
\NormalTok{    sample }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"2022"}\NormalTok{,m,}\StringTok{"15"}\NormalTok{,}\AttributeTok{sep=}\StringTok{"/"}\NormalTok{))),}\AttributeTok{geometry =}\NormalTok{ grid) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_sf}\NormalTok{()}
\NormalTok{  \} }\ControlFlowTok{else}
\NormalTok{  sample }\OtherTok{\textless{}{-}}\NormalTok{ sample }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{ymd}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"2022"}\NormalTok{,m,}\StringTok{"15"}\NormalTok{,}\AttributeTok{sep=}\StringTok{"/"}\NormalTok{))),}\AttributeTok{geometry =}\NormalTok{ grid))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Se le asocian todas las variables correspondientes a cada observación.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{source}\NormalTok{(}\StringTok{"scripts/strat/fun\_asignar\_variables.R"}\NormalTok{)}
\NormalTok{full\_grid  }\OtherTok{=} \FunctionTok{asignar\_variables}\NormalTok{(sample)}
\end{Highlighting}
\end{Shaded}

Se imputan los valores faltantes de NDVI asignándoles los del año
anterior, ya que faltan los archivos de marzo y diciembre de 2022.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# La siguiente función lee el archivo con el NDVI correspondiente a un mes y a un año dados (si está disponible)}

\NormalTok{read\_NDVI }\OtherTok{=} \ControlFlowTok{function}\NormalTok{(MM,YYYY) \{}
\NormalTok{  MM }\OtherTok{=} \FunctionTok{str\_pad}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(MM),}\DecValTok{2}\NormalTok{,}\StringTok{"left"}\NormalTok{,}\AttributeTok{pad =} \StringTok{"0"}\NormalTok{)}
\NormalTok{  YY }\OtherTok{=} \FunctionTok{substr}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(YYYY),}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(YY)}\SpecialCharTok{\textless{}=}\DecValTok{06}\NormalTok{) \{}
\NormalTok{    ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YYYY,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/TIFF/TERMOD\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi.tif"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(YY)}\SpecialCharTok{\textless{}=}\DecValTok{11}\NormalTok{) \{}
\NormalTok{    ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YYYY,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/TIF/TERMOD\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi.tif"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(YY)}\SpecialCharTok{\textless{}=}\DecValTok{21}\NormalTok{)\{}
\NormalTok{    ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YYYY,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/TIFF/termod\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi.tif"}\NormalTok{)}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    ruta }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data\_raw/vegetacion/"}\NormalTok{,YYYY,}\StringTok{"TERMODMEDMNDVI/InfGeografica/InfRaster/COG/termod\_"}\NormalTok{,YY,MM,}\StringTok{"01\_h17v05\_medmndvi\_COG.tif"}\NormalTok{)}
\NormalTok{  \}}

  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(ruta)) \{}
\NormalTok{    NDVI }\OtherTok{=} \FunctionTok{rast}\NormalTok{(ruta)}
\NormalTok{  \} }\ControlFlowTok{else}
\NormalTok{    NDVI }\OtherTok{=} \ConstantTok{NA}
  \FunctionTok{return}\NormalTok{(NDVI)}
\NormalTok{\}}

\CommentTok{\# Los meses para los cuales no está disponible el archivo de NDVI:}
\NormalTok{year\_month\_missing\_NDVI }\OtherTok{=} \FunctionTok{c}\NormalTok{(}
\StringTok{"2003{-}01"}\NormalTok{,}
\StringTok{"2003{-}04"}\NormalTok{,}
\StringTok{"2017{-}02"}\NormalTok{,}
\StringTok{"2018{-}11"}\NormalTok{,}
\StringTok{"2020{-}11"}\NormalTok{,}
\StringTok{"2021{-}12"}\NormalTok{,}
\StringTok{"2022{-}03"}\NormalTok{,}
\StringTok{"2022{-}12"}\NormalTok{)}

\CommentTok{\# Para cada observación para la que no está disponible el NDVI (porque la información de ese mes no está disponible), se obtiene el correspondiente al mismo mes del año anterior, si este está disponible, si no, el del año posterior:}

\NormalTok{missing\_NDVI }\OtherTok{=}\NormalTok{ full\_grid }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(NDVI)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \FunctionTok{year}\NormalTok{(date),}\AttributeTok{month =} \FunctionTok{month}\NormalTok{(date)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(year,month) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{paste}\NormalTok{(year,}\FunctionTok{str\_pad}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(month),}\DecValTok{2}\NormalTok{,}\StringTok{"left"}\NormalTok{,}\AttributeTok{pad =} \StringTok{"0"}\NormalTok{),}\AttributeTok{sep=}\StringTok{"{-}"}\NormalTok{) }\SpecialCharTok{\%in\%}\NormalTok{   year\_month\_missing\_NDVI) }\SpecialCharTok{|\textgreater{}}  \CommentTok{\# Se filtra porque también hay observaciones que tienen NA en el NDVI no porque no exista el archivo, si no lo mismo que en ocasiones anteriores, porques discrepancias entre los límites de los polígonos}
  \FunctionTok{nest}\NormalTok{() }\SpecialCharTok{|\textgreater{}}    
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{NDVI\_rast =} \FunctionTok{map2}\NormalTok{(month,year}\DecValTok{{-}1}\NormalTok{,read\_NDVI), }\CommentTok{\# Se lee primero el del año anterior}
         \AttributeTok{NDVI\_rast =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(NDVI\_rast)),}\FunctionTok{map2}\NormalTok{(month,year}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,read\_NDVI),NDVI\_rast), }\CommentTok{\# Si no está disponible, se toma el del año posterior}
         \AttributeTok{NDVI\_nuevo =} \FunctionTok{map2}\NormalTok{(NDVI\_rast,data,}\SpecialCharTok{\textasciitilde{}}\NormalTok{terra}\SpecialCharTok{::}\FunctionTok{extract}\NormalTok{(.x,.y)[,}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{NDVI\_rast) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{unnest}\NormalTok{(}\FunctionTok{c}\NormalTok{(data,NDVI\_nuevo)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{NDVI =}\NormalTok{ NDVI\_nuevo,}\AttributeTok{.keep=}\StringTok{"unused"}\NormalTok{)}

\NormalTok{ind\_modificados }\OtherTok{=} \FunctionTok{is.na}\NormalTok{(full\_grid}\SpecialCharTok{$}\NormalTok{NDVI) }\SpecialCharTok{\&}\NormalTok{ (}\FunctionTok{paste}\NormalTok{(}\FunctionTok{year}\NormalTok{(full\_grid}\SpecialCharTok{$}\NormalTok{date),}\FunctionTok{str\_pad}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(}\FunctionTok{month}\NormalTok{(full\_grid}\SpecialCharTok{$}\NormalTok{date)),}\DecValTok{2}\NormalTok{,}\StringTok{"left"}\NormalTok{,}\AttributeTok{pad =} \StringTok{"0"}\NormalTok{),}\AttributeTok{sep=}\StringTok{"{-}"}\NormalTok{) }\SpecialCharTok{\%in\%}\NormalTok{ year\_month\_missing\_NDVI) }\CommentTok{\# Los elementos que han sido modificados}

\CommentTok{\# Se asignan los valores imputados del NDVI:}
\NormalTok{full\_grid[ind\_modificados,]}\SpecialCharTok{$}\NormalTok{NDVI }\OtherTok{=}\NormalTok{ missing\_NDVI}\SpecialCharTok{$}\NormalTok{NDVI}

\CommentTok{\# Resumen}
\NormalTok{datos }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{  st\_drop\_geometry }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{skim}\NormalTok{(}\AttributeTok{.data\_name =} \StringTok{"datos"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Se agrupan los niveles de uso de suelo

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{full\_grid }\OtherTok{\textless{}{-}}\NormalTok{ full\_grid }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{uso\_suelo =} \FunctionTok{fct\_other}\NormalTok{(uso\_suelo,}
                               \AttributeTok{keep =} \FunctionTok{c}\NormalTok{(}\StringTok{"21"}\NormalTok{,}\StringTok{"22"}\NormalTok{,}\StringTok{"23"}\NormalTok{,}\StringTok{"24"}\NormalTok{,}\StringTok{"31"}\NormalTok{,}\StringTok{"32"}\NormalTok{,}\StringTok{"33"}\NormalTok{),}
                               \AttributeTok{other\_level=} \StringTok{"Otro"}\NormalTok{))}

\CommentTok{\# save(full\_grid,file = full\_grid\_meses\_2022\_processed.RData"}
\end{Highlighting}
\end{Shaded}

Se usará el modelo de regresión logística lasso final,

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\StringTok{"Private/all\_models\_test.RData"}\NormalTok{)}

\NormalTok{model }\OtherTok{\textless{}{-}}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(model\_name}\SpecialCharTok{==}\StringTok{"lr"}\NormalTok{)}
\CommentTok{\# model \textless{}{-} models \%\textgreater{}\% filter(model\_name=="svm\_linear")}
\CommentTok{\# model \textless{}{-} models \%\textgreater{}\% filter(model\_name=="rf")}

\FunctionTok{rm}\NormalTok{(models) }\CommentTok{\# Es un archivo muy pesado, lo eliminamos de la memoria}

\CommentTok{\# Predicciones}
\NormalTok{pred\_class }\OtherTok{=}\NormalTok{ model }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{pull}\NormalTok{(last\_fit) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[[}\DecValTok{1}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{predict}\NormalTok{(}\AttributeTok{new\_data =}\NormalTok{ full\_grid)}
\NormalTok{pred\_probs }\OtherTok{=}\NormalTok{ model }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{pull}\NormalTok{(last\_fit) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[[}\DecValTok{1}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{predict}\NormalTok{(}\AttributeTok{new\_data =}\NormalTok{ full\_grid,}\AttributeTok{type=}\StringTok{"prob"}\NormalTok{)}
\NormalTok{pred }\OtherTok{=} \FunctionTok{cbind}\NormalTok{(full\_grid,pred\_class,pred\_probs)}

\CommentTok{\# Se cargan los incendios producidos en el año 2022}
\NormalTok{incendios22 }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./data\_raw/incendios\_2000{-}2022/incendios\_"}\NormalTok{,}\DecValTok{2022}\NormalTok{,}\StringTok{".shp"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(full\_grid)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{date=}\FunctionTok{ymd}\NormalTok{(fecha\_inic))}
\end{Highlighting}
\end{Shaded}

Se muestra el gráfico con la estimación de la probabilidad de incendio
el día 15 de cada mes en todos los puntos. Se añaden los incendios
producidos en cada mes del año 2022

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Gráfico predicciones mes + Incendios producidos}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ and) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pred, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{.pred\_1),}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{,}\AttributeTok{size =} \FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{month}\NormalTok{(date,}\AttributeTok{label=}\ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T),}\AttributeTok{limits=}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ incendios22 }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ st\_centroid, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{shape =}\DecValTok{24}\NormalTok{, }\AttributeTok{size=}\DecValTok{1}\NormalTok{,}\AttributeTok{fill =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Probabilidad de incendio estimada el día 15 de cada mes de 2022"}\NormalTok{,}
       \AttributeTok{subtitle =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Modelo: "}\NormalTok{,model}\SpecialCharTok{$}\NormalTok{model\_name),}
       \AttributeTok{color =} \StringTok{"Probalidad}\SpecialCharTok{\textbackslash{}n}\StringTok{de incendio}\SpecialCharTok{\textbackslash{}n}\StringTok{estimada"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{caso-de-interuxe9s}{%
\section{Caso de interés}\label{caso-de-interuxe9s}}

Se va a usar el modelo para estudiar el incendio del 8 de septiembre de
2021 en Sierra Bermeja por ser de especial relevancia.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Se carga la información del incendio}
\NormalTok{incendios21 }\OtherTok{\textless{}{-}} \FunctionTok{st\_read}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./data\_raw/incendios\_2000{-}2022/incendios\_"}\NormalTok{,}\DecValTok{2021}\NormalTok{,}\StringTok{".shp"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos)) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{FECHA\_INIC=}\FunctionTok{ymd}\NormalTok{(FECHA\_INIC))}

\NormalTok{incendio\_estudio }\OtherTok{\textless{}{-}}\NormalTok{ incendios21 }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(}\FunctionTok{month}\NormalTok{(FECHA\_INIC)}\SpecialCharTok{==}\DecValTok{9}\NormalTok{)}
\FunctionTok{rm}\NormalTok{(incendios21)}

\CommentTok{\# Mapa de Andalucía y de las provincias}
\NormalTok{and }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_ccaa}\NormalTok{(}\AttributeTok{ccaa =} \StringTok{"Andalucía"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos))}
\NormalTok{prov }\OtherTok{\textless{}{-}} \FunctionTok{esp\_get\_prov}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(nuts2.name}\SpecialCharTok{==}\StringTok{"Andalucía"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_transform}\NormalTok{(}\FunctionTok{st\_crs}\NormalTok{(datos))}

\CommentTok{\# Gráfico del incendio}
\NormalTok{g }\OtherTok{=}\NormalTok{ prov }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ incendio\_estudio, }\AttributeTok{color=}\StringTok{"red"}\NormalTok{,}\AttributeTok{fill=}\FunctionTok{alpha}\NormalTok{(}\StringTok{"red"}\NormalTok{,}\FloatTok{0.2}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{()) }

\CommentTok{\# Ampliamos la zona del incendio }
\NormalTok{bbox }\OtherTok{=} \FunctionTok{st\_buffer}\NormalTok{(incendio\_estudio,}\AttributeTok{dist=}\DecValTok{10000}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{st\_bbox}\NormalTok{() }

\NormalTok{g1 }\OtherTok{=}\NormalTok{ prov }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ incendio\_estudio, }\AttributeTok{color=}\StringTok{"red"}\NormalTok{,}\AttributeTok{fill=}\FunctionTok{alpha}\NormalTok{(}\StringTok{"red"}\NormalTok{,}\FloatTok{0.2}\NormalTok{))}\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(bbox}\SpecialCharTok{$}\NormalTok{xmin,bbox}\SpecialCharTok{$}\NormalTok{xmax),}\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(bbox}\SpecialCharTok{$}\NormalTok{ymin,bbox}\SpecialCharTok{$}\NormalTok{ymax))}
 
\CommentTok{\# Gráfico final }
\NormalTok{gg }\OtherTok{\textless{}{-}} \FunctionTok{ggarrange}\NormalTok{(g,g1)}
\FunctionTok{annotate\_figure}\NormalTok{(gg, }
                \AttributeTok{top =} \FunctionTok{text\_grob}\NormalTok{(}\StringTok{"Caso de estudio: Incendio de Sierra Bermeja}\SpecialCharTok{\textbackslash{}n}\StringTok{8 de septiembre de 2021"}\NormalTok{,}\AttributeTok{size =} \DecValTok{14}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Se procede de forma similar a la sección anterior. Se crea una rejilla
de puntos con una separación de 1km, en la zona que rodea al incendio.
En cada punto se predecirá el riesgo de incendio el día de inicio del
incendio, 15 y 30 días antes y 15, 30 y 45 días después.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Se crea el grid}
\NormalTok{grid }\OtherTok{=} \FunctionTok{st\_make\_grid}\NormalTok{(}\FunctionTok{st\_buffer}\NormalTok{(incendio\_estudio,}\AttributeTok{dist=}\DecValTok{10000}\NormalTok{),}
                    \AttributeTok{cellsize =} \FunctionTok{c}\NormalTok{(}\DecValTok{1000}\NormalTok{,}\DecValTok{1000}\NormalTok{),}
                    \AttributeTok{what =} \StringTok{"centers"}\NormalTok{)[and]}

\CommentTok{\# Visualización}
\NormalTok{g }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ grid,}\AttributeTok{size=}\FloatTok{0.7}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(bbox}\SpecialCharTok{$}\NormalTok{xmin,bbox}\SpecialCharTok{$}\NormalTok{xmax),}\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(bbox}\SpecialCharTok{$}\NormalTok{ymin,bbox}\SpecialCharTok{$}\NormalTok{ymax))}

\CommentTok{\# Se le asocian las fechas respectivas}
\NormalTok{sample }\OtherTok{=} \FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendio\_estudio}\SpecialCharTok{$}\NormalTok{FECHA\_INIC,}\FunctionTok{length}\NormalTok{(grid)),}\AttributeTok{geometry =}\NormalTok{ grid) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# el día del incendio}
                 \FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendio\_estudio}\SpecialCharTok{$}\NormalTok{FECHA\_INIC}\SpecialCharTok{+}\DecValTok{15}\NormalTok{,}\FunctionTok{length}\NormalTok{(grid)),}\AttributeTok{geometry =}\NormalTok{ grid)) }\SpecialCharTok{\%\textgreater{}\%}  \CommentTok{\# 15 días después}
                 \FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendio\_estudio}\SpecialCharTok{$}\NormalTok{FECHA\_INIC}\SpecialCharTok{+}\DecValTok{30}\NormalTok{,}\FunctionTok{length}\NormalTok{(grid)),}\AttributeTok{geometry =}\NormalTok{ grid)) }\SpecialCharTok{\%\textgreater{}\%}  \CommentTok{\# el mes después}
                 \FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendio\_estudio}\SpecialCharTok{$}\NormalTok{FECHA\_INIC}\SpecialCharTok{+}\DecValTok{45}\NormalTok{,}\FunctionTok{length}\NormalTok{(grid)),}\AttributeTok{geometry =}\NormalTok{ grid)) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# 45 días después del incendio}
                \FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendio\_estudio}\SpecialCharTok{$}\NormalTok{FECHA\_INIC}\DecValTok{{-}15}\NormalTok{,}\FunctionTok{length}\NormalTok{(grid)), }\AttributeTok{geometry =}\NormalTok{ grid)) }\SpecialCharTok{\%\textgreater{}\%}  \CommentTok{\# 15 días antes}
                 \FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{date =} \FunctionTok{rep}\NormalTok{(incendio\_estudio}\SpecialCharTok{$}\NormalTok{FECHA\_INIC}\DecValTok{{-}30}\NormalTok{,}\FunctionTok{length}\NormalTok{(grid)),}\AttributeTok{geometry =}\NormalTok{ grid)) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# el mes antes}
  \FunctionTok{st\_sf}\NormalTok{() }
\end{Highlighting}
\end{Shaded}

Se le asocian a cada registro todas las variables predictoras
correspondientes.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{source}\NormalTok{(}\StringTok{"scripts/strat/fun\_asignar\_variables {-} copia.R"}\NormalTok{)}
\NormalTok{full\_grid }\OtherTok{\textless{}{-}} \FunctionTok{asignar\_variables}\NormalTok{(sample)}

\CommentTok{\# Se elimininas las observaciones con valores perdidos:}
\NormalTok{full\_grid }\OtherTok{\textless{}{-}}\NormalTok{ full\_grid }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{drop\_na}\NormalTok{()}

\CommentTok{\# Se agrupan los niveles de uso de suelo}
\NormalTok{full\_grid }\OtherTok{\textless{}{-}}\NormalTok{ full\_grid }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{uso\_suelo =} \FunctionTok{fct\_other}\NormalTok{(uso\_suelo,}
                               \AttributeTok{keep =} \FunctionTok{c}\NormalTok{(}\StringTok{"21"}\NormalTok{,}\StringTok{"22"}\NormalTok{,}\StringTok{"23"}\NormalTok{,}\StringTok{"24"}\NormalTok{,}\StringTok{"31"}\NormalTok{,}\StringTok{"32"}\NormalTok{,}\StringTok{"33"}\NormalTok{),}
                               \AttributeTok{other\_level=} \StringTok{"Otro"}\NormalTok{))}

\NormalTok{full\_grid }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{st\_drop\_geometry}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{skim}\NormalTok{()}

\CommentTok{\# save(full\_grid,file = "salidas\_intermedias/full\_grid\_incendio\_0921\_processed.RData")}
\end{Highlighting}
\end{Shaded}

Se usará el modelo de regresión logística lasso final para estimar la
probabilidad de incendio en cada punto.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\StringTok{"Private/all\_models\_test.RData"}\NormalTok{)}

\NormalTok{model }\OtherTok{\textless{}{-}}\NormalTok{ models }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(model\_name}\SpecialCharTok{==}\StringTok{"lr"}\NormalTok{)}
\CommentTok{\# model \textless{}{-} models \%\textgreater{}\% filter(model\_name=="svm\_rbf")}
\CommentTok{\# model \textless{}{-} models \%\textgreater{}\% filter(model\_name=="svm\_linear")}
\CommentTok{\# model \textless{}{-} models \%\textgreater{}\% filter(model\_name=="rf")}

\FunctionTok{rm}\NormalTok{(models) }\CommentTok{\# Es un archivo muy pesado, lo eliminamos de la memoria}

\CommentTok{\# Predicciones}
\NormalTok{pred\_class }\OtherTok{=}\NormalTok{ model }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{pull}\NormalTok{(last\_fit) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[[}\DecValTok{1}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{predict}\NormalTok{(}\AttributeTok{new\_data =}\NormalTok{ full\_grid)}
\NormalTok{pred\_probs }\OtherTok{=}\NormalTok{ model }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{pull}\NormalTok{(last\_fit) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  .[[}\DecValTok{1}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{predict}\NormalTok{(}\AttributeTok{new\_data =}\NormalTok{ full\_grid,}\AttributeTok{type=}\StringTok{"prob"}\NormalTok{)}
\NormalTok{pred }\OtherTok{=} \FunctionTok{cbind}\NormalTok{(full\_grid,pred\_class,pred\_probs)}
\end{Highlighting}
\end{Shaded}

Se muestra en un gráfico

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{g }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ and) }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pred, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{.pred\_1, }\AttributeTok{alpha =}\NormalTok{ .pred\_1),}\AttributeTok{size =} \FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{date) }\SpecialCharTok{+} 
  \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{rainbow}\NormalTok{(}\DecValTok{5}\NormalTok{,}\AttributeTok{rev=}\NormalTok{T),}\AttributeTok{limits=}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \CommentTok{\# scale\_color\_gradient(low="blue", high="red")+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title=}\StringTok{"Incendio de Sierra Bermeja"}\NormalTok{,}
       \AttributeTok{subtitle =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Model: "}\NormalTok{,model}\SpecialCharTok{$}\NormalTok{model\_name)) }\SpecialCharTok{+} 
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.x=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks.y=}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ incendio\_estudio, }\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{,}\AttributeTok{col=}\StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color =} \StringTok{"Probabilidad}\SpecialCharTok{\textbackslash{}n}\StringTok{estimada de}\SpecialCharTok{\textbackslash{}n}\StringTok{incendio"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{(}\AttributeTok{xlim=}\FunctionTok{c}\NormalTok{(bbox}\SpecialCharTok{$}\NormalTok{xmin,bbox}\SpecialCharTok{$}\NormalTok{xmax),}\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(bbox}\SpecialCharTok{$}\NormalTok{ymin,bbox}\SpecialCharTok{$}\NormalTok{ymax)) }
  
\NormalTok{g }
\end{Highlighting}
\end{Shaded}


\bibliography{bib/library.bib,bib/paquetes.bib}


%


\end{document}
