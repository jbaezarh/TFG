---
title: "Preprocesamiento"
author: "Juan Baeza Ruiz-Henestrosa"
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Librerías:
library(tidyverse)
library(sf)
```

Cargamos el archivo de datos:
```{r}
load("salidas_intermedias/dataset_completo2024-03-27.RData")

datos = dataset |> 
  select(-c(YEAR,MM,DD))
```

Se trata de un objeto de clase `sf` y `data.frame`:
```{r}
str(datos)
```

Variables:

    - fire: Variable respuesta con dos clases. Indica si en esa observación hay un incendio (1) o no (0).
        
    - date: Fecha de la observación
    
    - T2M: Temperatura del a 2m. The average air (dry bulb) temperature at 2 meters above the surface of the earth.

    - GWETTOP: Surface Soil Wetness. The percent of soil moisture a value of 0 indicates a completely water-free soil and a value of 1 indicates a completely saturated soil; where surface is the layer from the surface 0 cm to 5 cm below grade.
 
    - RH2M : Humedad relativa a 2m.The ratio of actual partial pressure of water vapor to the partial pressure at saturation, expressed in percent.
    
    - WD10M: Wind Direction at 10m. The average of the wind direction at 10 meters above the surface of the earth (º).
    
    - WS10M: Wind Speed at 10m. The average of wind speed at 10 meters above the surface of the earth (m/s).
    
    - PRECTOTCORR: Precipitation Corrected.  The bias corrected average of total precipitation at the surface of the earth in water mass (includes water content in snow) (mm/day).

    
    - elevacion: Elevación sobre el nivel del mar (m).
    
    - pendiente: Pendiente del terreno (º).
    
    - orientacion: Orientación de la pendiente descendiente medida en sentido de las agujas del reloj (º). Las áreas planas que no tienen dirección de pendiente descendente tienen un valor de -1.
    
https://desktop.arcgis.com/es/arcmap/latest/tools/spatial-analyst-toolbox/how-aspect-works.htm
    
    - curvatura: Curvatura de la superfie ()
    
    - dist_carretera:
    
    - dist_poblacion:
    
    - dist_electr:
    
    - dist_ferocarril  
    - dist_camino 
    - dist_sendero 
    
    - enp: Espacio Natural Protegido. Su valor es 1 si la observación se encuentra dentro de un espacio natural protegido o 0 en caso contrario.
    
    - cod_municipio: Código del municipio en el que está la observación.

    - municipio: Nombre del municipio en en el que está la observación.
    
    - poblacion: Número de habitantes del municipio en el que se encuentra la observación en ese año.
    
    - uso_suelo: Clasificación del uso del suelo.
    
    - dist_rios: Distancia al río más próximo (m).
    
    - NDVI: Índice de vegetación de diferencia normalizada.
    
    - geometry: Geometría de la simple feature. En este caso, coordenadas del punto. 
    

```{r}
summary(datos)
```


Indicamos las variables que son factores:

```{r}
datos <- datos |> 
  mutate(fire = as.factor(fire),
         enp = as.factor(enp),
         uso_suelo = as.factor(uso_suelo))
```


Es habitual trabajar con la orientación recodificada indicando cada uno de los 8 puntos cardinales o si no hay pendiente descendente.

```{r}
datos = datos |> 
  mutate(orientacion = cut(orientacion,
                           breaks = c(-Inf,-1,22.5,67.5,112.5,157.5,202.5,247.5,292.5,337.5,360),
                           labels = c("Plano","N","NE","E","SE","S","SW","W","NW","N")))
```


# NA's

```{r}
summary(datos)
```

Los valores perdidos de pendiente, orientación y curvatura se encuentran todos en los límites de Andalucía, como se muestra en el siguiente gráfico. Esto nos indica que la causa de que estos valores no estén disponibles es precisamente la discrepancia entre los distintos sistemas de referencia o entre los distintos polígonos utilizados para delimitar el territorio 

```{r}
plot(st_geometry(andalucia_proj),reset=F)
datos |> 
  filter(is.na(pendiente)| is.na(orientacion) | is.na(curvatura)) |> 
  st_geometry() |> 
  plot(pch=16,col="red",add=T)

datos |> 
  st_drop_geometry() |> 
  filter(is.na(pendiente)| is.na(orientacion) | is.na(curvatura)) |> 
  count() #53 observaciones NA

```

Al ser un número reducido de observaciones (53), puede ser razonable simplemente eliminarlas.

```{r}
datos = datos |> 
  filter(!(is.na(pendiente)| is.na(orientacion) | is.na(curvatura)))

summary(datos)
```

Los demás valores perdidos se encuentran en `población`, `uso_suelo` y `NDVI`.
    
    - En el caso de la población, es debido a que el dato de población para esos municipios concretos en esos años concretos no estaba disponible en la base de datos del INE.
    
```{r}
datos |> 
  st_drop_geometry() |> 
  filter(is.na(poblacion)) |> 
  mutate(Año = year(date)) |> 
  select(Año,municipio,cod_municipio)
```
    

Ejemplo : 
```{r}
pob = read_csv2("D:/usuario/Documents/Universidad/5º/TFG - organizado/data_raw/antropologicas/Población/poblacion_municipios.txt")[,c(1:5)]

pob |> filter(CODIGO_INE3 == "18077")
```


    - Uso de Suelo. Se trata de observaciones que se encuentran también en los límites de Andalucía, en este caso en la costa. Esto nos puede indicar que la causa de que este valor no esté disponible es la misma que anteriormente con las variables topográficas. Dado que el Sistema de Referencia de Coordenadas no se ha modificado, probablemente sea debido a pequeñas discrepancias entre los polígonos utilizados. Ante esto y teniendo en cuenta que son solo 3 observaciones, las eliminamos directamente.
    
```{r}
plot(st_geometry(andalucia_proj),reset=F)
datos |> filter(is.na(uso_suelo)) |> st_geometry() |> plot(pch=16,col="red",add=T)

datos = datos |>  
  filter(!is.na(uso_suelo))
```

    - El caso de los valores perdidos en NDVI es particular, ya que es debido a la falta la información de esos meses, por motivos que desconozco. 
    
```{r}
NDVI_mes = datos |> 
  st_drop_geometry() |> 
  mutate(mes = month(date),
         año = year(date)) |> 
  group_by(año,mes) |> 
  summarise(NDVI_mes = mean(na.omit(NDVI))) |> 
  ungroup() |> 
  mutate(date = dmy(paste(01,mes,año,sep="/")))
  

NDVI_mes |> 
  ggplot(aes(x=date,y=NDVI_mes)) +
  geom_line()+
  scale_x_date(date_breaks = "6 month",date_labels = "%y%b")+
  theme(axis.text.x = element_text(angle = 90))
  
```

Dos opciones: O eliminar los datos de 2000 y 2001 y imputar los demás o imputarlos todos.
    
    