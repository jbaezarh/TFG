---
title: "Casos de interés"
author: "Juan Baeza Ruiz-Henestrosa"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "D:/usuario/Documents/Universidad/5º/TFG - organizado") # Para que haga knitr desde el directorio del proyecto

```


```{r}
library(tidyverse)
library(tidymodels)
library(sf)
library(ggplot2)
library(terra)
library(mapSpain)
```

```{r}
load("salidas_intermedias/datos_strat_depurados_geom_2024-04-27.RData") # Datos
datos <- datos |> 
  mutate(uso_suelo = fct_lump(uso_suelo,
                              n = 7, # nos quedamos con los 7 niveles del factor más frecuentes (clases 2 y 3)
                              other_level= "Otro"))
table(datos$uso_suelo)

# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
```


Para poder estudiar casos concretos de interés, sin tener que hacer frente a todas las complicaciones derivadas del trabajar con datos raster, un enfoque puede ser el siguiente:


1. Estudiar un incendio concreto un día y ver como evoluciona el riesgo de incendio en los días cercanos, en el área de interés (un área que contenga al incendio que se quiere estudiar).

2. Generar puntos aleatoriamente en el área de interés (o formando una cuadrícula) en cada uno de los días cercanos al incendio. 

3. Asociar a cada punto sus variables correspondientes siguiendo el procedimiento usado para generar la muestra.

4. Usar el modelo para clasificar cada punto (o predecir la probabilidad de incendio).

5. Mostrar los gráficos de cada día con el polígono del incendio y compararlos para estudiar la capacidad de discretización del modelo.

6. En función del rendimiento del modelo se puede probar a extender el área de estudio y usar instantes de tiempo más alejados entre sí (p.e. semanas), pues es razonable que en días próximos y localizaciones cercanas los riesgos no varíen en exceso.

Si se obtienen resultados razonables, puede probarse a añadir variaciones en las variables climáticas (p.e. temperatura) para ver sus efectos.






# ---------------------

Se va a intentar estudiar el incendio del 8 de septiembre de 2021 en Sierra Bermeja por ser de especial relevancia.


```{r}
incendios21 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2021,".shp")) %>% 
  st_transform(st_crs(datos)) %>% 
  mutate(FECHA_INIC=ymd(FECHA_INIC))

incendio_estudio <- incendios21 %>% filter(month(FECHA_INIC)==9)

and <- esp_get_ccaa(ccaa = "Andalucía") %>% st_transform(st_crs(datos))
```


```{r}
g = and %>% 
  ggplot() +
  geom_sf() + 
  geom_sf(data = incendio_estudio, fill=alpha("black",0))
g


```


```{r}
# grid de puntos 10km x 10km de andalucía
grid = st_make_grid(and,
                    cellsize = c(25000,25000), # 10000
                    what = "centers")[and]

g + geom_sf(data = grid)
```


```{r}
sample = st_sf(tibble(date = rep(incendio_estudio$FECHA_INIC,length(grid)),geometry = grid) %>% # el día del incendio
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC+15,length(grid)),geometry = grid)) %>%  # 15 días después
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC+15,length(grid)),geometry = grid)) %>%  # el mes después
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC-15,length(grid)),geometry = grid)) %>%  # 15 días antes
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC-30,length(grid)),geometry = grid))) # el mes antes


source("scripts/strat/fun_asignar_variables.R")
full_grid  = asignar_variables(sample)

full_grid
```

Se usará el modelo de regresión lineal entrenado con los datos de entrenamiento y validación

```{r}
# Cargar lr_model en modelos
model
pred_class = last_lr_fit %>% extract_workflow() %>% predict(new_data = full_grid)
pred_probs = last_lr_fit %>% extract_workflow() %>% predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)

g + geom_sf(data = pred, mapping = aes(color=.pred_class))

g + 
  geom_sf(data = pred, mapping = aes(color=.pred_1)) +
  scale_color_gradientn(colours = rainbow(5,rev=T)) 
```


```{r}
# Más detalle
# grid de puntos 10km x 10km de andalucía
grid = st_make_grid(st_buffer(incendio_estudio,dist=10000),
                    cellsize = c(1000,1000),
                    what = "centers")[and]

# ----------
g + geom_sf(data = grid)

# sample = st_sf(tibble(date = rep(incendio_estudio$FECHA_INIC,length(grid)),geometry = grid))

sample = st_sf(tibble(date = rep(incendio_estudio$FECHA_INIC,length(grid)),geometry = grid) %>% # el día del incendio
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC+15,length(grid)),geometry = grid)) %>%  # 15 días después
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC+15,length(grid)),geometry = grid)) %>%  # el mes después
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC-15,length(grid)),geometry = grid)) %>%  # 15 días antes
                 bind_rows(tibble(date = rep(incendio_estudio$FECHA_INIC-30,length(grid)),geometry = grid))) # el mes antes


source("scripts/strat/fun_asignar_variables.R")
full_grid  = asignar_variables(sample)


# ----------

# Cargar lr_model en modelos
pred_class = last_lr_fit %>% extract_workflow() %>% predict(new_data = full_grid)
pred_probs = last_lr_fit %>% extract_workflow() %>% predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)

g + geom_sf(data = pred, mapping = aes(color=.pred_class))

bbox = st_bbox(st_buffer(incendio_estudio,dist=10000)) %>%  as.matrix() %>% t() %>% as.data.frame()

g + 
  geom_sf(data = pred, mapping = aes(color=.pred_class)) +
 #scale_color_gradientn(colours = rainbow(5,rev=T))  +
  geom_sf(data=incendio_estudio,fill = alpha("black",0)) +
  coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))


g + 
  geom_sf(data = pred, mapping = aes(color=.pred_1)) +
  scale_color_gradientn(colours = rainbow(5,rev=T))  +
  geom_sf(data=incendio_estudio,fill = alpha("black",0)) +
  coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))

# Lógico ya que es un problema muy complejo y la resolución de las variables meteorológicas es de alrededor de 50km, por lo que intentar hacer predicciones a una escala menor (en este caso 50 veces menor) no es una buena idea
# Además el incendio duró 46 días
```



