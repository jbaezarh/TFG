.[[1]] %>%
extract_workflow() %>%
predict(new_data = clim1,type="prob")
pred_clim1 = cbind(full_grid,pred_class_clim1,pred_probs_clim1)
g_clim1 <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred_clim1, aes(color=.pred_1, alpha = .pred_0),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("temp + 10%") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g_clim1
g
clim1 <- full_grid %>%
mutate(T2M = 1.10*T2M,
GWETTOP = 0.8*GWETTOP,
PRECTOTCORR = 0.5*PRECTOTCORR)
pred_class_clim1 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = clim1)
pred_probs_clim1 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = clim1,type="prob")
pred_clim1 = cbind(full_grid,pred_class_clim1,pred_probs_clim1)
g_clim1 <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred_clim1, aes(color=.pred_1, alpha = .pred_0),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("temp + 10%") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g_clim1
g
clim1 <- full_grid %>%
mutate(T2M = 1.10*T2M,
GWETTOP = 0.8*GWETTOP,
PRECTOTCORR = 0.8*PRECTOTCORR,
NDVI = 0.8*NDVI,
RH2M = 0.8*RH2M)
pred_class_clim1 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = clim1)
pred_probs_clim1 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = clim1,type="prob")
pred_clim1 = cbind(full_grid,pred_class_clim1,pred_probs_clim1)
g_clim1 <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred_clim1, aes(color=.pred_1, alpha = .pred_0),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("temp + 10%") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g_clim1
g
g_clim1 <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred_clim1, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("temp + 10%") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g_clim1
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g
incendios22 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2022,".shp")) %>%
st_transform(st_crs(full_grid)) %>%
mutate(date=ymd(fecha_inic))
incendios22 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2022,".shp")) %>%
st_transform(st_crs(full_grid)) %>%
mutate(date=ymd(fecha_inic))
g +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.2,linetype="dotted")
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = 0.8.pred_1),size = 1.5) +
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = 0.7*pred_1),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.2,linetype="dotted")
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = 0.7*.pred_1),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.2,linetype="dotted")
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1),alpha=0.5,size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.2,linetype="dotted")
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1),alpha=0.5,size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.5,linetype="dotted")
temp05 <- full_grid %>%
mutate(T2M = 1.05*T2M)
pred_class_temp05 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = temp05)
pred_probs_temp05 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = temp05,type="prob")
pred_temp05 = cbind(full_grid,pred_class_temp05,pred_probs_temp05)
temp10 <- full_grid %>%
mutate(T2M = 1.10*T2M)
pred_class_temp10 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = temp10)
pred_probs_temp10 = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = temp10,type="prob")
pred_temp10 = cbind(full_grid,pred_class_temp10,pred_probs_temp10)
boxplot(cbind(pred$.pred_1,pred_temp05$.pred_1,pred_class_temp10$.pred_1))
cbind(pred$.pred_1,pred_temp05$.pred_1,pred_class_temp10$.pred_1)
boxplot(data.frame(Original = pred$.pred_1,
Temp05 =pred_temp05$.pred_1,
Temp10 =pred_class_temp10$.pred_1))
pred$.pred_1
pred_temp05$.pred_1
boxplot(data.frame(Original = pred$.pred_1,
Temp05 =pred_temp05$.pred_1,
Temp10 =pred_temp10$.pred_1))
library(tidyverse)
library(tidymodels)
library(sf)
library(ggplot2)
library(terra)
library(mapSpain)
library(skimr)
load("salidas_intermedias/datos_strat_depurados_geom_2024-04-27.RData") # Datos
datos <- datos |>
mutate(uso_suelo = fct_lump(uso_suelo,
n = 7, # nos quedamos con los 7 niveles del factor más frecuentes (clases 2 y 3)
other_level= "Otro"))
and <- esp_get_ccaa(ccaa = "Andalucía") %>% st_transform(st_crs(datos))
# grid de puntos 10km x 10km de andalucía
grid = st_make_grid(and,
cellsize = c(10000,10000), # 10000
what = "centers")[and]
g = and %>%
ggplot() +
geom_sf() +
theme_minimal()
g + geom_sf(data = grid,color="red",size=0.6)
and <- esp_get_ccaa(ccaa = "Andalucía") %>% st_transform(st_crs(datos))
load("salidas_intermedias/full_grid_meses_2022_processed.RData")
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
lr_final <- models %>% filter(model_name=="lr")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = lr_final %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Probabilidad estimada de incendio el día 15 de cada mes") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g
incendios22 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2022,".shp")) %>%
st_transform(st_crs(full_grid)) %>%
mutate(date=ymd(fecha_inic))
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1),alpha=0.5,size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Title") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.5,linetype="dotted")
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1),alpha=0.5,size = 1.5) +
facet_wrap(~month(date,label=TRUE)) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
ggtitle("Probabilidad estimada de incendio forestal + Incendios observados") +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendios22, color = "red",fill="transparent") +
geom_sf(data = st_buffer(incendios22,dist=5000), color = "firebrick",fill="firebrick",alpha=0.5,linetype="dotted")
full_grid[incendios22]
full_grid[incendios22,]
mean(pred[incendios22,]$.pred_1)
pred[incendios22,]$.pred_1 %>% boxplot()
pred[incendios22,] %>%
select(.pred_1) %>%
ggplot() +
geom_boxplot()
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot()
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot() +
theme_minimal()
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot(fill = "grey") +
theme_minimal() +
```
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot(fill = "grey") +
theme_minimal() +
labs(title = "Boxplot de la probabilidad estimada de incendio en las localizaciones en
las que ha habido incendio")
pred[incendios22,]$.pred_1 %>% boxplot()
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot(fill = "grey") +
theme_minimal() +
labs(title = "Boxplot de la probabilidad estimada de incendio en las localizaciones en
las que ha habido incendio")
pred[incendios22,]$.pred_1 %>% summary()
# En las localizaciones en las que no ha habido incendio
pred[-incendios22,]$.pred_1 %>% summary()
# pred[incendios22,] %>%
#   ggplot(aes(y = .pred_1)) +
#   geom_boxplot(fill = "grey") +
#   theme_minimal() +
#   labs(title = "Boxplot de la probabilidad estimada de incendio en las localizaciones en
#        las que ha habido incendio")
# En las localizaciones en las que no ha habido incendio
pred[-incendios22,]$.pred_1 %>% summary()
# En las localizaciones en las que no ha habido incendio
pred[-c(incendios22),]$.pred_1 %>% summary()
pred[incendios22,]
pred[7985,] %>% st_disjoint(incendios22)
pred[7985,]
pred[7985,] %>% st_is_disjoint(incendios22)
?st_filter
pred %>% st_filter(y=incendios22,.predicat=st_disjoint)
pred %>% st_filter(y=incendios22,.predicat=st_intersects)
# En las localizaciones en las que no ha habido incendio
pred[incendios22,,op=st_intersects]$.pred_1 %>% summary()
# En las localizaciones en las que no ha habido incendio
pred[incendios22,$.pred_1 %>% summary()
,op=st_intersects
# En las localizaciones en las que no ha habido incendio
pred[incendios22,]$.pred_1 %>% summary()
# En las localizaciones en las que no ha habido incendio
pred[incendios22,,op=st_disjoint]$.pred_1 %>% summary()
# En las localizaciones en las que no ha habido incendio
pred[incendios22,,op=st_disjoint]
pred[incendios22,,op=st_is_within_distance(0)]
pred[incendios22,,op=st_is_within_distance()]
pred[incendios22,,op=st_is_within_distance]
pred[incendios22,]
# En las localizaciones en las que no ha habido incendio
pred[incendios22,,op=st_intersects]
st_filter(pred,incendios22)
# En las localizaciones en las que ha habido incendio
pred[incendios22,]$.pred_1 %>% summary()
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot(fill = "grey") +
theme_minimal() +
labs(title = "Boxplot de la probabilidad estimada de incendio en las localizaciones en
las que ha habido incendio")
pred[incendios22,]$.pred_1 %>% boxplot()
pred[incendios22,] %>%
ggplot(aes(y = .pred_1)) +
geom_boxplot(fill = "grey") +
theme_minimal() +
labs(title = "Boxplot de la probabilidad estimada de incendio en las localizaciones en
las que ha habido incendio")
incendios21 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2021,".shp")) %>%
st_transform(st_crs(datos)) %>%
mutate(FECHA_INIC=ymd(FECHA_INIC))
incendio_estudio <- incendios21 %>% filter(month(FECHA_INIC)==9)
and <- esp_get_ccaa(ccaa = "Andalucía") %>% st_transform(st_crs(datos))
g = and %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, fill=alpha("black",0))
g
g = and %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("black",0.2))
g = and %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("black",0.2))
g
g = and %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("black",0.2))+
theme_minimal()
g
g = and %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("red",0.2))+
theme_minimal()
g
bbox = st_bbox(st_buffer(incendio_estudio,dist=10000)) %>%  as.matrix() %>% t() %>% as.data.frame()
bbox = st_buffer(incendio_estudio,dist=10000) %>%
st_bbox() %>%
as.matrix() %>% t() %>%
as.data.frame()
bbox
st_buffer(incendio_estudio,dist=10000) %>%
st_bbox()
bbox = st_buffer(incendio_estudio,dist=10000) %>%
st_bbox()
str(bbox)
attributes(bbox,"xmin")
attributes(bbox)
?attributes
bbox[[1]]
bbox[1]
bbox$xmin
g +
geom_sf(data = pred, mapping = aes(color=.pred_class)) +
#scale_color_gradientn(colours = rainbow(5,rev=T))  +
geom_sf(data=incendio_estudio,fill = alpha("black",0))
g +
#scale_color_gradientn(colours = rainbow(5,rev=T))  +
geom_sf(data=incendio_estudio,fill = alpha("black",0))
g + coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g + coord_sf(bbox)
g + coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
# Más detalle
grid = st_make_grid(st_buffer(incendio_estudio,dist=10000),
cellsize = c(1000,1000),
what = "centers")[and]
# ----------
g + geom_sf(data = grid)
g1 <- g +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
# ----------
g1 + geom_sf(data = grid)
g1 <- g +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g1
# ----------
g1 +
geom_sf(data = grid)
g + coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
# ----------
g +
geom_sf(data = grid) +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
# ----------
g +
geom_sf(data = grid,size=0.7) +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
