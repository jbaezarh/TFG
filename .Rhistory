ggarrange(g,g1)
g = prov %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("red",0.2))+
theme_minimal()+
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
# labs(title = "Caso de estudio: Incendio de Sierra Bermeja",
#      subtitle = "8 de septiembre de 2021") +
# theme(plot.title = element_text(face="bold"))
g
g = prov %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("red",0.2))+
theme_minimal()+
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
g1 = prov %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("red",0.2))+
theme_minimal() +
# labs(title = "Caso de estudio: Incendio de Sierra Bermeja",
#      subtitle = "8 de septiembre de 2021") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
ggarrange(g,g1)
gg <- ggarrange(g,g1)
annotate_figure(gg, top = text_grob("Caso de estudio: Incendio de Sierra Bermeja",
color = "red", face = "bold", size = 14))
annotate_figure(gg, top = text_grob("Caso de estudio: Incendio de Sierra Bermeja",
face = "bold", size = 14))
?annotate_figure
annotate_figure(gg, top = text_grob("Caso de estudio: Incendio de Sierra Bermeja\n
8 de septiembre de 2021",
face = "bold", size = 14))
annotate_figure(gg, top = text_grob("Caso de estudio: Incendio de Sierra Bermeja\n8de septiembre de 2021",
face = "bold", size = 14))
annotate_figure(gg, top = text_grob("Caso de estudio: Incendio de Sierra Bermeja\n8 de septiembre de 2021",
size = 14))
incendios21 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2021,".shp")) %>%
st_transform(st_crs(datos)) %>%
mutate(FECHA_INIC=ymd(FECHA_INIC))
library(tidyverse)
library(tidymodels)
library(sf)
library(ggplot2)
library(terra)
library(mapSpain)
library(skimr)
library(ggpubr)
incendios21 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2021,".shp")) %>%
st_transform(st_crs(datos)) %>%
mutate(FECHA_INIC=ymd(FECHA_INIC))
load("salidas_intermedias/datos_strat_depurados_geom_2024-04-27.RData") # Datos
datos <- datos |>
mutate(uso_suelo = fct_lump(uso_suelo,
n = 7, # nos quedamos con los 7 niveles del factor más frecuentes (clases 2 y 3)
other_level= "Otro"))
incendios21 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2021,".shp")) %>%
st_transform(st_crs(datos)) %>%
mutate(FECHA_INIC=ymd(FECHA_INIC))
incendio_estudio <- incendios21 %>% filter(month(FECHA_INIC)==9)
incendio_estudio
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "D:/usuario/Documents/Universidad/5º/TFG - organizado") # Para que haga knitr desde el directorio del proyecto
# Chunk 2
library(tidyverse)
library(tidymodels)
library(sf)
library(ggplot2)
library(terra)
library(mapSpain)
library(skimr)
library(ggpubr)
# Chunk 3
load("salidas_intermedias/datos_strat_depurados_geom_2024-04-27.RData") # Datos
datos <- datos |>
mutate(uso_suelo = fct_lump(uso_suelo,
n = 7, # nos quedamos con los 7 niveles del factor más frecuentes (clases 2 y 3)
other_level= "Otro"))
and <- esp_get_ccaa(ccaa = "Andalucía") %>% st_transform(st_crs(datos))
incendios21 <- st_read(paste0("./data_raw/incendios_2000-2022/incendios_",2021,".shp")) %>%
st_transform(st_crs(datos)) %>%
mutate(FECHA_INIC=ymd(FECHA_INIC))
incendio_estudio <- incendios21 %>% filter(month(FECHA_INIC)==9)
and <- esp_get_ccaa(ccaa = "Andalucía") %>% st_transform(st_crs(datos))
rm(incendios21)
prov <- esp_get_prov() %>% filter(nuts2.name=="Andalucía") %>% st_transform(st_crs(datos))
g = prov %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("red",0.2))+
theme_minimal()+
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank())
bbox = st_buffer(incendio_estudio,dist=10000) %>%
st_bbox()
g1 = g + coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g1 = prov %>%
ggplot() +
geom_sf() +
geom_sf(data = incendio_estudio, color="red",fill=alpha("red",0.2))+
theme_minimal() +
# labs(title = "Caso de estudio: Incendio de Sierra Bermeja",
#      subtitle = "8 de septiembre de 2021") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
gg <- ggarrange(g,g1)
annotate_figure(gg, top = text_grob("Caso de estudio: Incendio de Sierra Bermeja\n8 de septiembre de 2021",
size = 14))
# save(full_grid,file = "salidas_intermedias/full_grid_incendio_0921_processed.RData")
load("salidas_intermedias/full_grid_incendio_0921_processed.RData")
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
model <- models %>% filter(model_name=="lr")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja, 8 de septiembre de 2021",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja, 8 de septiembre de 2021",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
g1
g1 + geom_sf(data = st_buffer(incendio_estudio,dist=10000))
ggplot(bbox %>% st_sf())
ggplot(bbox %>% st_sfc()
)
ggplot(bbox %>% st_sfc())
ggplot(bbox %>% st_as_sfc())
ggplot(bbox %>% st_as_sfc()) + geom_sf()
ggplot(bbox %>% st_as_sfc()) + geom_sf() + geom_sf(data = st_buffer(incendio_estudio,dist=10000)) + geom_sf(data=incendio_estudio)
# model <- models %>% filter(model_name=="lr")
model <- models %>% filter(model_name=="svm_linear")
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
# model <- models %>% filter(model_name=="lr")
model <- models %>% filter(model_name=="svm_linear")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
# model <- models %>% filter(model_name=="lr")
# model <- models %>% filter(model_name=="svm_linear")
model <- models %>% filter(model_name=="rf")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
# model <- models %>% filter(model_name=="lr")
model <- models %>% filter(model_name=="knn")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
# model <- models %>% filter(model_name=="lr")
model <- models %>% filter(model_name=="svm_rdf")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
models
# model <- models %>% filter(model_name=="lr")
model <- models %>% filter(model_name=="svm_rbf")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
models
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=pred_class, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=pred_class, alpha = .pred_1),size = 1.5) +
facet_wrap(~date)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=pred_class, alpha = pred_class),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
# load("salidas_intermedias/trained_models_strat_2024_04_28.RData") # Modelos
load("Private/all_models_test.RData")
model <- models %>% filter(model_name=="lr")
rm(models) # Es un archivo muy pesado, lo eliminamos de la memoria
pred_class = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid)
pred_probs = model %>%
pull(last_fit) %>%
.[[1]] %>%
extract_workflow() %>%
predict(new_data = full_grid,type="prob")
pred = cbind(full_grid,pred_class,pred_probs)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_1, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=pred_class, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=pred_class, alpha = .pred_1),size = 1.5) +
facet_wrap(~date)
summary(pred)
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_class, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
g <- ggplot(data = and) +
geom_sf() +
geom_sf(data = pred, aes(color=.pred_class, alpha = .pred_1),size = 1.5) +
facet_wrap(~date) +
# scale_color_gradientn(colours = rainbow(5,rev=T),limits=c(0,1)) +
# scale_color_gradient(low="blue", high="red")+
labs(title="Incendio de Sierra Bermeja",
subtitle = paste0("Model: ",model$model_name)) +
guides(alpha = "none") +
theme_minimal() +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) +
geom_sf(data = incendio_estudio, fill="transparent",col="red") +
labs(color = "Probabilidad\nestimada de\nincendio") +
coord_sf(xlim=c(bbox$xmin,bbox$xmax),ylim=c(bbox$ymin,bbox$ymax))
g
